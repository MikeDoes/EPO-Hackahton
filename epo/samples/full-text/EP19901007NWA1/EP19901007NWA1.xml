<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ep-patent-document PUBLIC "-//EPO//EP PATENT DOCUMENT 1.5.1//EN" "ep-patent-document-v1-5-1.dtd">
<!-- This XML data has been generated under the supervision of the European Patent Office -->
<ep-patent-document id="EP19901007A1" file="EP19901007NWA1.xml" lang="en" country="EP" doc-number="3889766" kind="A1" date-publ="20211006" status="n" dtd-version="ep-patent-document-v1-5-1">
<SDOBI lang="en"><B000><eptags><B001EP>ATBECHDEDKESFRGBGRITLILUNLSEMCPTIESILTLVFIROMKCYALTRBGCZEEHUPLSKBAHRIS..MTNORSMESMMAKHTNMD..........</B001EP><B005EP>J</B005EP><B007EP>BDM Ver 2.0.12 (4th of August) -  1100000/0</B007EP></eptags></B000><B100><B110>3889766</B110><B120><B121>EUROPEAN PATENT APPLICATION</B121><B121EP>published in accordance with Art. 153(4) EPC</B121EP></B120><B130>A1</B130><B140><date>20211006</date></B140><B190>EP</B190></B100><B200><B210>19901007.5</B210><B220><date>20190628</date></B220><B240><B241><date>20210628</date></B241></B240><B250>zh</B250><B251EP>en</B251EP><B260>en</B260></B200><B300><B310>201811558091</B310><B320><date>20181219</date></B320><B330><ctry>CN</ctry></B330></B300><B400><B405><date>20211006</date><bnum>202140</bnum></B405><B430><date>20211006</date><bnum>202140</bnum></B430></B400><B500><B510EP><classification-ipcr sequence="1"><text>G06F   8/658       20180101AFI20200701BHEP        </text></classification-ipcr><classification-ipcr sequence="2"><text>G06F   8/71        20180101ALI20200701BHEP        </text></classification-ipcr></B510EP><B540><B541>de</B541><B542>GESICHERTES FIRMWARE-AKTUALISIERUNGSVERFAHREN, VORRICHTUNG, BORDSYSTEM UND FAHRZEUG</B542><B541>en</B541><B542>SECURE FIRMWARE UPGRADE METHOD, DEVICE, ON-BOARD SYSTEM, AND VEHICLE</B542><B541>fr</B541><B542>PROCÉDÉ DE MISE À NIVEAU SÉCURISÉE DE MICROPROGRAMME, DISPOSITIF, SYSTÈME EMBARQUÉ, ET VÉHICULE</B542></B540><B590><B598>1</B598></B590></B500><B700><B710><B711><snm>Guangzhou Xiaopeng Motors Technology Co., Ltd.</snm><iid>101899502</iid><irf>G 0154 WOEP</irf><adr><str>Room 245, No. 333, Jiufo Jianshe Road 
Sino-Singapore Guangzhou Knowledge City</str><city>Guangzhou, Guangdong 510000</city><ctry>CN</ctry></adr></B711></B710><B720><B721><snm>TAN, Weihua</snm><adr><str>Room 245 No. 333, Jiufo Jianshe Road Sino- 
Singapore Guangzhou Knowledge City</str><city>Guangzhou, Guangdong 510000</city><ctry>CN</ctry></adr></B721></B720><B740><B741><snm>Habermann, Hruschka &amp; Schnabel</snm><iid>101257190</iid><adr><str>Patentanwälte 
Montgelasstraße 2</str><city>81679 München</city><ctry>DE</ctry></adr></B741></B740></B700><B800><B840><ctry>AL</ctry><ctry>AT</ctry><ctry>BE</ctry><ctry>BG</ctry><ctry>CH</ctry><ctry>CY</ctry><ctry>CZ</ctry><ctry>DE</ctry><ctry>DK</ctry><ctry>EE</ctry><ctry>ES</ctry><ctry>FI</ctry><ctry>FR</ctry><ctry>GB</ctry><ctry>GR</ctry><ctry>HR</ctry><ctry>HU</ctry><ctry>IE</ctry><ctry>IS</ctry><ctry>IT</ctry><ctry>LI</ctry><ctry>LT</ctry><ctry>LU</ctry><ctry>LV</ctry><ctry>MC</ctry><ctry>MK</ctry><ctry>MT</ctry><ctry>NL</ctry><ctry>NO</ctry><ctry>PL</ctry><ctry>PT</ctry><ctry>RO</ctry><ctry>RS</ctry><ctry>SE</ctry><ctry>SI</ctry><ctry>SK</ctry><ctry>SM</ctry><ctry>TR</ctry></B840><B844EP><B845EP><ctry>BA</ctry></B845EP><B845EP><ctry>ME</ctry></B845EP></B844EP><B848EP><B849EP><ctry>KH</ctry></B849EP><B849EP><ctry>MA</ctry></B849EP><B849EP><ctry>MD</ctry></B849EP><B849EP><ctry>TN</ctry></B849EP></B848EP><B860><B861><dnum><anum>CN2019093435</anum></dnum><date>20190628</date></B861><B862>zh</B862></B860><B870><B871><dnum><pnum>WO2020124985</pnum></dnum><date>20200625</date><bnum>202026</bnum></B871></B870></B800></SDOBI>
<abstract id="abst" lang="en">
<p id="pa01" num="0001">The present disclosure relates to a secure firmware upgrade method, a device, an in-vehicle system, and a vehicle. The method includes: performing decryption and signature verification on a received firmware upgrade package; transmitting, based on the firmware upgrade package, a firmware writing instruction to a corresponding apparatus to be upgraded; transmitting, based on a writing success instruction received from the apparatus, a security verification instruction to the apparatus; receiving and verifying a response instruction transmitted by the apparatus in response to the security verification instruction; and transmitting, in response to the response instruction being a predetermined response instruction, an upgrade success message to complete a firmware upgrade. The technical solution according to embodiments of the present disclosure is applicable to Over-the-Air (OTA) upgrades and On Board Diagnostics (OBD) interface upgrades, and checks consistency between running firmware after an upgrade and released firmware, thereby solving a security issue of illegal writing of a firmware package resulted from bypassing security limitations of an upgrade channel.<img id="iaf01" file="imgaf001.tif" wi="78" he="102" img-content="drawing" img-format="tif"/></p>
</abstract>
<description id="desc" lang="en"><!-- EPO <DP n="1"> -->
<heading id="h0001"><b>TECHNICAL FIELD</b></heading>
<p id="p0001" num="0001">The present disclosure belongs to the field of information security technologies, and more particularly, relates to a secure firmware upgrade method, a device, an in-vehicle system, and a vehicle.</p>
<heading id="h0002"><b>BACKGROUND</b></heading>
<p id="p0002" num="0002">Firmware is a program written into an Erasable Read-Only Memory (EROM) or an Electrically Erasable Programmable Read-Only Memory (EEPROM), and is a "driver" stored inside a device. Through the firmware, an operating system can realize a running action of a specific machine according to a standard device driver. A firmware upgrade refers to upgrading embedded firmware of the device, which can improve functions of the device, enhance stability, and repair vulnerabilities.</p>
<p id="p0003" num="0003">In the related art, all interfaces for firmware upgrades in the device are at risk of malicious use by an attacker. The attacker may hijack a channel for a firmware upgrade and write a self-made firmware upgrade package into the device. In this way, a corresponding module of the device is controlled, or even the entire device is controlled in a Controller Area Network (CAN) bus, so as to achieve purposes such as stealing a control right of the device, and stealing data. Therefore, for occasions with extremely high security requirements such as smart vehicles, security of firmware upgrades is very important. A controller of a smart vehicle should be prevented from being stolen in an illegal firmware upgrade.</p>
<p id="p0004" num="0004">In order to ensure the security of the firmware upgrades of the device, it is usually possible to ensure that an original firmware upgrade package is not tampered with during a writing process of the firmware upgrade package. However, it is neither possible to monitor whether a firmware upgrade package actually running in the device subsequently is the original firmware upgrade package written into the device, nor possible to perform security verification on a firmware upgrade package version. That is, the attacker may bypass security restrictions of an upgrade channel, write the self-made firmware upgrade package into the device, and run the self-made firmware upgrade package, which poses a security risk.<!-- EPO <DP n="2"> --></p>
<p id="p0005" num="0005">In addition, for a situation where the firmware upgrade package is written through accessing the bus via a physical interface, e.g., the firmware upgrade package is written through accessing the bus via an On Board Diagnostics (OBD) interface, most of the security detection mechanisms can be bypassed to write the firmware upgrade package made by the attacker. If the attacker maliciously writes the firmware through the above method, and there is no corresponding detection mechanism and warning mechanism in the device, the user will not be able to sense the writing.</p>
<heading id="h0003"><b>SUMMARY</b></heading>
<p id="p0006" num="0006">In order to solve the above technical problem of low security of a firmware upgrade, the present disclosure provides a secure firmware upgrade method, a device, an in-vehicle system, and a vehicle.</p>
<p id="p0007" num="0007">In an aspect, an embodiment of the present disclosure provides a secure firmware upgrade method, including:
<ul id="ul0001" list-style="none" compact="compact">
<li>performing decryption and signature verification on a received firmware upgrade package;</li>
<li>transmitting, based on the firmware upgrade package, a firmware writing instruction to a corresponding apparatus to be upgraded;</li>
<li>transmitting, based on a writing success instruction received from the apparatus, a security verification instruction to the apparatus;</li>
<li>receiving and verifying a response instruction transmitted by the apparatus in response to the security verification instruction; and</li>
<li>transmitting, in response to the response instruction being a predetermined response instruction, an upgrade success message to complete a firmware upgrade.</li>
</ul></p>
<p id="p0008" num="0008">Further, the firmware upgrade package is preconfigured with a response algorithm for generating the response instruction corresponding to the security verification instruction, different versions of firmware upgrade packages correspond to a same security verification instruction and different response instructions, and there is an one-to-one correspondence between the different versions of the firmware upgrade packages and security verification instructions and response instructions.</p>
<p id="p0009" num="0009">Further, said performing decryption and signature verification on the received firmware upgrade package includes recording a version number of the firmware upgrade package in response to success of the signature verification.</p>
<p id="p0010" num="0010">Further, said verifying the response instruction includes: determining the firmware upgrade to be secure, when the response instruction transmitted by the apparatus is identical to the predetermined response instruction pre-stored in the response algorithm preconfigured in the received firmware upgrade package; and determining the firmware upgrade to be abnormal,<!-- EPO <DP n="3"> --> when the response instruction transmitted by the apparatus is different from the predetermined response instruction pre-stored in the response algorithm preconfigured in the received firmware upgrade package.</p>
<p id="p0011" num="0011">Further, during writing of the firmware upgrade package, security detection is performed on the apparatus to ensure security during the firmware upgrade.</p>
<p id="p0012" num="0012">Further, in response to the response instruction being inconsistent with the predetermined response instruction, an abnormality warning is transmitted.</p>
<p id="p0013" num="0013">In another aspect, an embodiment of the present disclosure provides a secure firmware upgrade device. The secure firmware upgrade device includes a firmware upgrade package obtaining module, a firmware writing instruction transmitting module, a security verification instruction transmitting module, a response instruction receiving module, and a determining module.</p>
<p id="p0014" num="0014">The firmware upgrade package obtaining module is configured to perform decryption and signature verification on a received firmware upgrade package.</p>
<p id="p0015" num="0015">The firmware writing instruction transmitting module is configured to transmit, based on the firmware upgrade package, a firmware writing instruction to a corresponding apparatus to be upgraded.</p>
<p id="p0016" num="0016">The security verification instruction transmitting module is configured to transmit, based on a writing success instruction received from the apparatus, a security verification instruction to the apparatus.</p>
<p id="p0017" num="0017">The response instruction receiving module is configured to receive a response instruction transmitted by the apparatus in response to the security verification instruction.</p>
<p id="p0018" num="0018">The determining module is configured to transmit, in response to the response instruction being a predetermined response instruction, an upgrade success message to complete a firmware upgrade.</p>
<p id="p0019" num="0019">In yet another aspect, an embodiment of the present disclosure provides a secure firmware upgrade method, including:
<ul id="ul0002" list-style="none" compact="compact">
<li>receiving a firmware writing instruction for an apparatus to be upgraded, and entering a monitoring mode;</li>
<li>transmitting, in response to a writing success instruction of a firmware upgrade package from the apparatus to be upgraded being monitored, a security verification instruction to the apparatus;</li>
<li>receiving and verifying a response instruction transmitted by the apparatus in response to the security verification instruction; and</li>
<li>transmitting, in response to the response instruction being a predetermined response instruction, an upgrade success message to complete a firmware upgrade.</li>
</ul></p>
<p id="p0020" num="0020">Further, the firmware upgrade package is preconfigured with a response algorithm<!-- EPO <DP n="4"> --> for generating the response instruction corresponding to the security verification instruction, different versions of firmware upgrade packages correspond to a same security verification instruction and different response instructions, and there is an one-to-one correspondence between the different versions of the firmware upgrade packages and security verification instructions and response instructions.</p>
<p id="p0021" num="0021">Further, a version number of the firmware upgrade package is received together with the response instruction transmitted by the apparatus.</p>
<p id="p0022" num="0022">Further, said verifying the response instruction includes: determining the firmware upgrade to be secure, when the response instruction transmitted by the apparatus is identical to the predetermined response instruction pre-stored in the response algorithm preconfigured in the received firmware upgrade package; and determining the firmware upgrade to be abnormal, when the response instruction transmitted by the apparatus is different from the predetermined response instruction pre-stored in the response algorithm preconfigured in the received firmware upgrade package.</p>
<p id="p0023" num="0023">Further, in response to the response instruction being inconsistent with the predetermined response instruction, an abnormality warning is transmitted.</p>
<p id="p0024" num="0024">In still yet another aspect, an embodiment of the present disclosure provides a secure firmware upgrade device. The secure firmware upgrade device includes a monitoring module, a security verification instruction transmitting module, a response instruction receiving module, and a determining module.</p>
<p id="p0025" num="0025">The monitoring module is configured to receive a firmware writing instruction for an apparatus to be upgraded, and enter a monitoring mode.</p>
<p id="p0026" num="0026">The security verification instruction transmitting module is configured to transmit, in response to a writing success instruction of the apparatus being monitored by the monitoring module, a security verification instruction to the apparatus.</p>
<p id="p0027" num="0027">The response instruction receiving module is configured to receive a response instruction transmitted by the apparatus in response to the security verification instruction.</p>
<p id="p0028" num="0028">The determining module is configured to transmit, in response to the response instruction being a predetermined response instruction, an upgrade success message to complete a firmware upgrade.</p>
<p id="p0029" num="0029">An embodiment of the present disclosure further provides an in-vehicle system. The in-vehicle system is configured with at least one of the secure firmware upgrade devices described above therein.</p>
<p id="p0030" num="0030">An embodiment of the present disclosure further provides a vehicle. The vehicle includes the in-vehicle system as described above.</p>
<p id="p0031" num="0031">Beneficial effects of the present disclosure are as follows. The secure firmware upgrade method, the device, the in-vehicle system, and the vehicle according to an embodiment<!-- EPO <DP n="5"> --> of the present disclosure are applicable to Over-the-Air (OTA) upgrades and On Board Diagnostics <b>(OBD)</b> interface upgrades. By packing a preset response algorithm in a firmware upgrade package in advance, after a device completes writing of firmware, a security verification and verification instruction is transmitted to perform security verification by validating a response instruction generated by the response algorithm. In this way, it is possible to solve a security issue of illegal writing of a firmware package resulted from bypassing security limitations of an upgrade channel by checking consistency between running firmware after an upgrade and released firmware.</p>
<heading id="h0004"><b>BRIEF DESCRIPTION OF DRAWINGS</b></heading>
<p id="p0032" num="0032">
<ul id="ul0003" list-style="none" compact="compact">
<li><figref idref="f0001">FIG. 1</figref> is a flowchart illustrating a secure firmware upgrade method according to Embodiment 1 of the present disclosure;</li>
<li><figref idref="f0002">FIG. 2</figref> is a schematic diagram showing a system applying a secure firmware upgrade method according to Embodiment 1 of the present disclosure;</li>
<li><figref idref="f0003">FIG. 3</figref> is a block diagram showing a secure firmware upgrade device according to Embodiment 2 of the present disclosure;</li>
<li><figref idref="f0004">FIG. 4</figref> is a flowchart illustrating a secure firmware upgrade method according to Embodiment 3 of the present disclosure;</li>
<li><figref idref="f0005">FIG. 5</figref> is a schematic diagram showing a system applying a secure firmware upgrade method according to Embodiment 3 of the present disclosure; and</li>
<li><figref idref="f0006">FIG. 6</figref> is a block diagram showing a secure firmware upgrade device according to Embodiment 4 of the present disclosure.</li>
</ul></p>
<heading id="h0005"><b>DESCRIPTION OF EMBODIMENTS</b></heading>
<p id="p0033" num="0033">In order to make objects, technical solutions, and advantages of the present disclosure clearer, the following further describes the present disclosure in detail in combination with specific embodiments and with reference to the accompanying drawings. However, those skilled in the art understand that the present disclosure is not limited to the accompanying drawings and the following embodiments.</p>
<heading id="h0006"><b>Embodiment 1</b></heading>
<p id="p0034" num="0034">An embodiment of the present disclosure provides a secure firmware upgrade method, which is used to upgrade firmware of an apparatus, and is especially suitable for a situation where an Over-the-Air (OTA) method is used for a remote firmware upgrade. The apparatus may be a vehicle. As illustrated in <figref idref="f0001">FIG. 1</figref>, the method includes the following steps.</p>
<p id="p0035" num="0035">At S11, decryption and signature verification are performed on a received firmware upgrade package. During a packaging process of the firmware upgrade package, the firmware upgrade package is encrypted and added with a digital signature, so as to ensure the security of the firmware upgrade package itself. An encryption algorithm and a signature algorithm may<!-- EPO <DP n="6"> --> be any achievable algorithm in the related art, and the present disclosure is not limited to this. After the firmware upgrade package is received, a decryption algorithm and the signature verification are executed. The decryption algorithm and the encryption algorithm correspond to each other. A signature verification process corresponds to a signature process.</p>
<p id="p0036" num="0036">Further, the firmware upgrade package is preconfigured with a response algorithm for generating a response instruction corresponding to the security verification instruction. During the packaging process of the firmware upgrade package, a logic implementation program that generates the response instruction corresponding to the security verification instruction is written in advance for subsequent security verification. Different versions of firmware upgrade packages correspond to a same security verification instruction and different response instructions. There is an one-to-one correspondence between the different versions of the firmware upgrade packages and security verification instructions and response instructions.</p>
<p id="p0037" num="0037">For example, for different versions of the firmware upgrade packages, the response algorithm has different response instructions, in response to the same security verification instruction a or b, as illustrated in Table 1:
<tables id="tabl0001" num="0001">
<table frame="all">
<title>Table 1</title>
<tgroup cols="3">
<colspec colnum="1" colname="col1" colwidth="64mm"/>
<colspec colnum="2" colname="col2" colwidth="48mm"/>
<colspec colnum="3" colname="col3" colwidth="36mm"/>
<thead>
<row>
<entry align="center" valign="top">Versions of the firmware upgrade package</entry>
<entry align="center" valign="top">Security verification instruction</entry>
<entry align="center" valign="top">Response instruction</entry></row></thead>
<tbody>
<row>
<entry align="center">V1.0</entry>
<entry align="center">a</entry>
<entry align="center">B</entry></row>
<row>
<entry align="center">V2.0</entry>
<entry align="center">a</entry>
<entry align="center">C</entry></row>
<row>
<entry align="center">V3.0</entry>
<entry align="center">a</entry>
<entry align="center">D</entry></row>
<row>
<entry align="center">V1.0</entry>
<entry align="center">b</entry>
<entry align="center">X</entry></row>
<row>
<entry align="center">V2.0</entry>
<entry align="center">b</entry>
<entry align="center">Y</entry></row>
<row>
<entry align="center">V3.0</entry>
<entry align="center">b</entry>
<entry align="center">Z</entry></row></tbody></tgroup>
</table>
</tables></p>
<p id="p0038" num="0038">That is, in response to the same security verification instruction a, the response instruction of version VI.0 of the firmware upgrade package is B, the response instruction of version V2.0 of the firmware upgrade package is C, and the response instruction of version V3.0 of the firmware upgrade package is D. In response to the same security verification instruction b, the response instruction of version VI.0 of the firmware upgrade package is X, the response instruction of version V2.0 of the firmware upgrade package is Y, and the response instruction of version V3.0 of the firmware upgrade package is Z. Therefore, there is an one-to-one correspondence between the different versions V1.0, V2.0, V3.0 of the firmware upgrade packages and security verification instructions and response instructions, as illustrated in Table 1.</p>
<p id="p0039" num="0039">Based on the above response algorithm, in step S11, a version number of the firmware upgrade package is recorded in response to success of the signature verification, such that a predetermined response instruction is obtained by using the above response algorithm related to the version of the firmware upgrade package, based on the recorded version number<!-- EPO <DP n="7"> --> of the firmware upgrade package. In this embodiment, the predetermined response instruction is a response instruction associated with the version of the firmware upgrade package and the security verification instruction in Table 1, such that the response instruction can be compared with a response instruction transmitted by the apparatus in a subsequent step S15.</p>
<p id="p0040" num="0040">At S 12, a firmware writing instruction is transmitted, based on the received firmware upgrade package, to a corresponding apparatus to be upgraded.</p>
<p id="p0041" num="0041">In response to success of a decryption and signature verification process, the firmware upgrade package is obtained. The firmware writing instruction is transmitted, based on the received firmware upgrade package, to the corresponding apparatus to be upgraded, so as to start a firmware writing process.</p>
<p id="p0042" num="0042">The apparatus to be upgraded uses the firmware upgrade package to perform firmware writing in accordance with a writing protocol, loads the firmware upgrade package into a corresponding storage module, and updates version information of the firmware to the version of the firmware upgrade package.</p>
<p id="p0043" num="0043">In a process of writing the firmware upgrade package, security detection is performed on the apparatus to ensure security during a firmware upgrade process. Detection content includes whether there is a hijacked and/or tampered interference data packet in an internal network of the apparatus, whether a written component is in a normal working condition, and whether the apparatus is in an abnormal network connection, e.g., a connection from an attacker. If one of the above situations exists, writing of the firmware upgrade package of a current version can be stopped, and the previous firmware version can be restored.</p>
<p id="p0044" num="0044">After completing the writing of the firmware, the apparatus transmits a writing success instruction.</p>
<p id="p0045" num="0045">At S13, a security verification instruction is transmitted, based on a writing success instruction received from the apparatus to be upgraded, to the apparatus to be upgraded.</p>
<p id="p0046" num="0046">The apparatus receives the security verification instruction, and uses a response algorithm preconfigured in the written firmware upgrade package to transmit a corresponding response instruction for the version of the written firmware upgrade package.</p>
<p id="p0047" num="0047">At S14, a response instruction transmitted by the apparatus in response to the security verification instruction is received and verified.</p>
<p id="p0048" num="0048">At S15, an upgrade success message is transmitted, in response to the response instruction being a predetermined response instruction, to complete a firmware upgrade.</p>
<p id="p0049" num="0049">Specifically, after receiving the response instruction transmitted by the apparatus, the response instruction transmitted by the apparatus is compared with the predetermined response instruction pre-stored in the response algorithm preconfigured in the received firmware upgrade package. In the present embodiment, the predetermined response instruction is the above response instruction associated with the version of the firmware upgrade package<!-- EPO <DP n="8"> --> and the security verification instruction. When the response instruction transmitted by the apparatus is generated by the apparatus based on the response algorithm preset in the written firmware upgrade package, then the response instruction transmitted by the apparatus is identical to the predetermined response instruction pre-stored in the response algorithm preconfigured in the received firmware upgrade package, and thus the firmware upgrade is determined to be secure; and when the response instruction transmitted by the apparatus is different from the predetermined response instruction pre-stored in the response algorithm preconfigured in the received firmware upgrade package, it is indicated that a security risk exists in the firmware upgrade package written by corresponding firmware. In this way, the firmware upgrade is determined and recorded to be abnormal, and a security warning is transmitted through a network. In addition, it is not allowed to use an OTA mode to operate the apparatus until unlocking is performed by a risk removal process.</p>
<p id="p0050" num="0050">For example, after the apparatus has completed the writing of the firmware upgrade package V1.0, a security verification instruction a is transmitted to the apparatus. The apparatus generates a response instruction H, and transmits the response instruction H back.</p>
<p id="p0051" num="0051">According to the pre-stored response algorithm preconfigured in the received firmware upgrade package, the response instruction of the firmware upgrade package VI.0 corresponding to the security verification instruction a is B, and the predetermined response instruction is B.</p>
<p id="p0052" num="0052">After the response instruction H transmitted by the apparatus in response to the security verification instruction a is received, the response instruction H transmitted by the apparatus is compared with the predetermined response instruction B pre-stored in the response algorithm preconfigured in the received firmware upgrade package V1.0. If H=B, the firmware upgrade is determined to be secure. If H≠B, it is determined and recorded that the firmware upgrade is abnormal, and a security warning is transmitted through a network. In addition, it is not allowed to use the OTA mode to operate the apparatus until unlocking is performed by the risk removal process.</p>
<p id="p0053" num="0053">Hereinafter, the secure firmware upgrade method according to Embodiment 1 of the present disclosure is described by taking an example of performing the remote firmware upgrade on the vehicle in the OTA mode.</p>
<p id="p0054" num="0054">As illustrated in <figref idref="f0002">FIG. 2</figref>, a secure firmware upgrade system of the secure firmware upgrade method includes an OTA server for OTA upgrades, an in-vehicle security chip module ESU, and an electronic unit ECU to be written and upgraded. The OTA server stores a challenge-end algorithm, i.e., the response algorithm according to Embodiment 1 of the present disclosure, of a challenge response Tag. The in-vehicle security chip module ESU executes steps of the secure firmware upgrade method according to Embodiment 1 of the present disclosure. When there are a number of security verification instructions, the response algorithm<!-- EPO <DP n="9"> --> can be as illustrated in Table 1. In this example, the challenge-end algorithm includes only one security verification instruction AAA. For example, for the firmware of version V1.1, when the security verification instruction AAA is received, a response instruction BBB is fed back.</p>
<p id="p0055" num="0055">In step 1, the OTA server transmits the challenge-end algorithm to the in-vehicle security chip module ESU, and the in-vehicle security chip module ESU pre-stores the challenge-end algorithm.</p>
<p id="p0056" num="0056">In step 2, the OTA server for OTA upgrades includes or generates a firmware package, i.e., the firmware upgrade package according to Embodiment 1 of the present disclosure, for upgrading. The challenge-end algorithm is preconfigured in the upgraded firmware package.</p>
<p id="p0057" num="0057">Since the challenge-end algorithm in this example includes only one security verification instruction AAA, pre-configuring the challenge-end algorithm in the upgraded firmware package is specifically to package a challenge response Tag of a hardcode in the upgraded firmware package. For example, for the firmware of version V1.1, when the security verification instruction AAA is received, the response instruction BBB is fed back.</p>
<p id="p0058" num="0058">In step 3, the in-vehicle security chip module ESU obtains the upgraded firmware package, downloads the upgraded firmware package to the in-vehicle security chip module ESU, and performs the decryption and signature verification. If the verification is passed, the in-vehicle security chip module ESU records the version number of the upgraded firmware package, e.g., V1.1, and transmits the firmware writing instruction.</p>
<p id="p0059" num="0059">In step 4, the in-vehicle security chip module ESU or other writing control components use the upgraded firmware package to write the firmware of the electronic unit ECU to be written and upgraded in accordance with the writing protocol. After the firmware is successfully written, the electronic unit ECU runs the new firmware.</p>
<p id="p0060" num="0060">In step 5, the in-vehicle security chip module ESU initiates the challenge-end algorithm based on the recorded version number V1.1 of the upgraded firmware package, and transmits the security verification instruction AAA to the electronic unit ECU (a predetermined response instruction BBB is expected to be fed back).</p>
<p id="p0061" num="0061">In step 6, after the electronic unit ECU receives the security verification instruction AAA transmitted by the in-vehicle security chip module ESU, the response instruction is transmitted to the security chip module ESU.</p>
<p id="p0062" num="0062">If the response instruction transmitted by the electronic unit ECU to the in-vehicle security chip module ESU is the predetermined response instruction BBB, the in-vehicle security chip module ESU determines that the response is normal, and the firmware upgrade of the electronic unit ECU is successful. If the response instruction transmitted by the electronic unit ECU to the security chip module ESU is different from the predetermined response instruction BBB, the in-vehicle security chip module ESU determines that the response is<!-- EPO <DP n="10"> --> abnormal, and a security risk exists in the firmware package written by the electronic unit ECU. In this way, it is determined and recorded that the firmware upgrade is abnormal, and a security warning is transmitted by the security chip module ESU to the vehicle and/or the OTA server through the network. In addition, it is forbidden to use the OTA mode to operate the vehicle.</p>
<heading id="h0007"><b>Embodiment 2</b></heading>
<p id="p0063" num="0063">An embodiment of the present disclosure provides a secure firmware upgrade device, which is used to upgrade the firmware of the apparatus, and is especially suitable for the situation where the OTA mode is used for the remote firmware upgrade. The apparatus may be a vehicle. As illustrated in <figref idref="f0003">FIG. 3</figref>, the secure firmware upgrade device includes a firmware upgrade package obtaining module, a firmware writing instruction transmitting module, a security verification instruction transmitting module, a response instruction receiving module, and a determining module.</p>
<p id="p0064" num="0064">The firmware upgrade package obtaining module is configured to perform decryption and signature verification on a received firmware upgrade package. During the packaging process of the firmware upgrade package, the firmware upgrade package is encrypted and added with a digital signature, so as to ensure the security of the firmware upgrade package. The encryption algorithm and the signature algorithm may be any achievable algorithm in the related art, and the present disclosure is not limited to this. After the firmware upgrade package is received, the decryption algorithm and the signature verification are performed. The decryption algorithm and the encryption algorithm correspond to each other. A signature verification process corresponds to a signature process.</p>
<p id="p0065" num="0065">Further, the firmware upgrade package is preconfigured with a response algorithm for generating a response instruction corresponding to a security verification instruction. During a packaging process of the firmware upgrade package, a logic implementation program that generates the response instruction corresponding to the security verification instruction is written in advance for subsequent security verification. Different versions of firmware upgrade packages correspond to a same security verification instruction and different response instructions. There is an one-to-one correspondence between the different versions of the firmware upgrade packages and security verification instructions and response instructions.</p>
<p id="p0066" num="0066">For example, for different versions of the firmware upgrade packages, the response algorithm has different response instructions in response to the same security verification instruction a or b, as illustrated in Table 1. That is, in response to the same security verification instruction a, the response instruction of version VI.0 of the firmware upgrade package is B, the response instruction of version V2.0 of the firmware upgrade package is C, and the response instruction of version V3.0 of the firmware upgrade package is D. In response to the same security verification instruction b, the response instruction of version VI.0 of the firmware upgrade package is X, the response instruction of version V2.0 of the firmware upgrade package<!-- EPO <DP n="11"> --> is Y, and the response instruction of version V3.0 of the firmware upgrade package is Z. Therefore, there is an one-to-one correspondence between the different versions VI.0, V2.0, V3.0 of the firmware upgrade packages and the security verification instructions and the response instructions, as illustrated in Table 1.</p>
<p id="p0067" num="0067">Based on the above response algorithm, in response to the success of the signature verification, the firmware upgrade package obtaining module is configured to record the version number of the firmware upgrade package, so as to obtain the predetermined response instruction used by the determining module. According to the recorded version number of the firmware upgrade package, using the above response algorithm related to the version of the firmware upgrade package can obtain the predetermined response instruction. In this embodiment, the predetermined response instruction is a response instruction associated with the version of the firmware upgrade package and the security verification instruction in Table 1.</p>
<p id="p0068" num="0068">The firmware writing instruction transmitting module is configured to transmit, based on the received firmware upgrade package, a firmware writing instruction to a corresponding apparatus to be upgraded.</p>
<p id="p0069" num="0069">In response to success of a decryption and signature verification process, the firmware upgrade package is obtained. The firmware writing instruction is transmitted, based on the received firmware upgrade package, to the corresponding apparatus to be upgraded, so as to start the firmware writing process.</p>
<p id="p0070" num="0070">The apparatus to be upgraded uses the firmware upgrade package to perform firmware writing in accordance with the writing protocol, loads the firmware upgrade package into a corresponding storage module, and updates the version information of the firmware to the version of the firmware upgrade package.</p>
<p id="p0071" num="0071">In a process of writing the firmware upgrade package, the firmware writing instruction transmitting module is configured to perform the security detection on the apparatus to ensure security during a firmware upgrade process. Detection content includes whether there is a hijacked and/or tampered interference data packet in the internal network of the apparatus, whether the written firmware is in a normal working condition, and whether the apparatus is in an abnormal network connection, e.g., a connection from an attacker. If one of the above situations exists, writing of the firmware upgrade package of the current version can be stopped, and the previous firmware version can be restored.</p>
<p id="p0072" num="0072">After completing the writing of the firmware, the apparatus transmits the writing success instruction.</p>
<p id="p0073" num="0073">The security verification instruction transmitting module is configured to transmit, based on a writing success instruction received from the apparatus to be upgraded, a security verification instruction to the apparatus to be upgraded. The apparatus receives the security verification instruction, and uses the response algorithm preconfigured in the written firmware<!-- EPO <DP n="12"> --> upgrade package to transmit a corresponding response instruction for the version of the written firmware upgrade package.</p>
<p id="p0074" num="0074">The response instruction receiving module is configured to receive a response instruction transmitted by the apparatus in response to the security verification instruction.</p>
<p id="p0075" num="0075">The determining module is configured to transmit, in response to the response instruction being a predetermined response instruction, an upgrade success message to complete a firmware upgrade. Specifically, after receiving the response instruction transmitted by the apparatus, the determining module compares the response instruction transmitted by the apparatus with the predetermined response instruction pre-stored in the response algorithm preconfigured in the received firmware upgrade package. In the present embodiment, the predetermined response instruction is the above response instruction associated with the version of the firmware upgrade package and the security verification instruction. When the response instruction transmitted by the apparatus is generated by the apparatus based on the response algorithm preset in the written firmware upgrade package, then the response instruction transmitted by the apparatus is identical to the predetermined response instruction pre-stored in the response algorithm preconfigured in the received firmware upgrade package, and thus the determining module determines the firmware upgrade to be secure; and when the response instruction transmitted by the apparatus is different from the predetermined response instruction pre-stored in the response algorithm preconfigured in the received firmware upgrade package, it is indicated that the security risk exists in the firmware upgrade package written by corresponding firmware, the determining module determines and records the firmware upgrade to be abnormal, and the security warning is transmitted through the network. In addition, it is not allowed to use the OTA mode to operate the apparatus until unlocking is performed by the risk removal process.</p>
<p id="p0076" num="0076">For example, after the apparatus has completed the writing of the firmware upgrade package VI.0, the security verification instruction a is transmitted to the apparatus. The apparatus generates the response instruction H, and transmits the response instruction H back.</p>
<p id="p0077" num="0077">According to the pre-stored response algorithm preconfigured in the received firmware upgrade package, the response instruction of the firmware upgrade package VI.0 corresponding to the security verification instruction a is B, and the predetermined response instruction is B.</p>
<p id="p0078" num="0078">After receiving the response instruction H transmitted by the apparatus in response to the security verification instruction a, the determining module compares the response instruction H transmitted by the apparatus with the predetermined response instruction B pre-stored in the response algorithm preconfigured in the received firmware upgrade package V1.0. If H=B, the firmware upgrade is determined to be secure. If H≠B, it is determined and recorded that the firmware upgrade is abnormal, and the security warning is transmitted through the<!-- EPO <DP n="13"> --> network. In addition, it is not allowed to use the OTA mode to operate the apparatus until unlocking is performed by the risk removal process.</p>
<heading id="h0008"><b>Embodiment 3</b></heading>
<p id="p0079" num="0079">An embodiment of the present disclosure provides a secure firmware upgrade method, which is used to upgrade the firmware of the apparatus, and is especially suitable for a situation where the firmware upgrade is performed in an On Board Diagnostics (OBD) interface mode. As illustrated in <figref idref="f0004">FIG. 4</figref>, the method includes the following steps.</p>
<p id="p0080" num="0080">At S21, a firmware writing instruction for an apparatus to be upgraded is received, and a monitoring mode is entered.</p>
<p id="p0081" num="0081">Specifically, the writing instruction in a Controller Area Network (CAN) bus or a local area network where the apparatus is located is monitored. In response to monitoring the firmware writing instruction for the apparatus to be upgraded, the monitoring mode is entered to monitor a writing progress of the firmware.</p>
<p id="p0082" num="0082">An online diagnostic tool receives the firmware upgrade package, uses a secret key and a digital certificate to perform decryption and signature verification on the received firmware upgrade package, and uses the firmware upgrade package to write the firmware in accordance with the writing protocol. The firmware upgrade package is loaded to a corresponding storage module. The version information of the firmware is updated to the version number of the firmware upgrade package. During the packaging process of the firmware upgrade package, the firmware upgrade package is encrypted and added with a digital signature, so as to ensure the security of the firmware upgrade package. The encryption algorithm and the signature algorithm may be any achievable algorithm in the related art, and the present disclosure is not limited in this regard. After the firmware upgrade package is received, a decryption algorithm and a signature verification are performed. The decryption algorithm and the encryption algorithm correspond to each other. The signature verification process corresponds to the signature process.</p>
<p id="p0083" num="0083">Further, the firmware upgrade package is preconfigured with the response algorithm for generating a response instruction corresponding to the security verification instruction. During the packaging process of the firmware upgrade package, the logic implementation program that generates the corresponding response instruction for the security verification instruction is written in advance for subsequent security verification. Different versions of the firmware upgrade packages correspond to the same security verification instruction and different response instructions. There is an one-to-one correspondence between the different versions of the firmware upgrade packages and the security verification instructions and the response instructions.</p>
<p id="p0084" num="0084">For example, for different versions of the firmware upgrade packages, the response algorithm corresponds to the same security verification instruction a or b, and has different<!-- EPO <DP n="14"> --> response instructions, as illustrated in Table 1. That is, in response to the same security verification instruction a, the response instruction of version VI.0 of the firmware upgrade package is B, the response instruction of version V2.0 of the firmware upgrade package is C, and the response instruction of version V3.0 of the firmware upgrade package is D. In response to the same security verification instruction b, the response instruction of version VI.0 of the firmware upgrade package is X, the response instruction of version V2.0 of the firmware upgrade package is Y, and the response instruction of version V3.0 of the firmware upgrade package is Z. Therefore, there is an one-to-one correspondence between the different versions VI.0, V2.0, V3.0 of the firmware upgrade packages and the security verification instructions and the response instructions, as illustrated in Table 1.</p>
<p id="p0085" num="0085">At S22, a security verification instruction is transmitted, in response to a writing success instruction of the apparatus to be upgraded being monitored, to the apparatus to be upgraded.</p>
<p id="p0086" num="0086">Based on the above response algorithm related to the version of the firmware upgrade package, the apparatus needs to transmit the response instruction and the version number of the firmware upgrade package back after receiving the security verification instruction. Under normal circumstances, the apparatus uses the response algorithm preconfigured in the written firmware upgrade package to transmit a corresponding response instruction for the firmware upgrade package of the written version.</p>
<p id="p0087" num="0087">At S23, a response instruction transmitted by the apparatus in response to the security verification instruction is received and verified.</p>
<p id="p0088" num="0088">In an embodiment, the version number of the firmware upgrade package is received based on the above response algorithm related to the version of the firmware upgrade package, together with the response instruction transmitted by the apparatus, such that the predetermined response instruction can be obtained by using, based on the received version number of the firmware upgrade package, the above response algorithm related to the version of the firmware upgrade package, that is, the response instruction associated with the version of the firmware upgrade package and the security verification instruction in Table 1, so as to facilitate a comparison between the predetermined response instruction and the response instruction transmitted by the apparatus in a subsequent step S24.</p>
<p id="p0089" num="0089">At S24, an upgrade success message is transmitted, in response to the response instruction being a predetermined response instruction, to complete a firmware upgrade. Specifically, after the response instruction transmitted by the apparatus is received, the response instruction transmitted by the apparatus is compared with the predetermined response instruction pre-stored in the response algorithm preconfigured in the firmware upgrade package. In the present embodiment, the predetermined response instruction is the above response instruction associated with the version of the firmware upgrade package and the<!-- EPO <DP n="15"> --> security verification instruction. When the response instruction transmitted by the apparatus is generated by the apparatus based on the response algorithm preconfigured in the written firmware upgrade package, then the response instruction transmitted by the apparatus is identical to the predetermined response instruction pre-stored in the response algorithm preconfigured in the firmware upgrade package, and thus the firmware upgrade is determined to be secure; and when the response instruction transmitted by the apparatus is different from the predetermined response instruction pre-stored in the response algorithm preconfigured in the firmware upgrade package, it is indicated that a security risk exists in the firmware upgrade package written by corresponding firmware. In this way, the firmware upgrade is determined and recorded to be abnormal, and the security warning is transmitted through the network. In addition, it is not allowed to use an OBD mode to operate the apparatus until unlocking is performed by the risk removal process.</p>
<p id="p0090" num="0090">For example, after the apparatus has completed the writing of the firmware upgrade package VI.0, the security verification instruction a is transmitted to the apparatus. The apparatus generates the response instruction H, and transmits the response instruction H and the version number VI.0 of the firmware upgrade package back.</p>
<p id="p0091" num="0091">According to the pre-stored response algorithm preconfigured in the firmware upgrade package, the response instruction of the firmware upgrade package V1.0 corresponding to the security verification instruction a is B, and the predetermined response instruction is B.</p>
<p id="p0092" num="0092">After the response instruction H transmitted by the apparatus in response to the security verification instruction a and the version number V1.0 of the firmware upgrade package are received, the response instruction H transmitted by the apparatus is compared with the predetermined response instruction B pre-stored in the response algorithm preconfigured in the firmware upgrade package V1.0. If H=B, the firmware upgrade is determined to be secure. If H≠B, it is determined and recorded that the firmware upgrade is abnormal, and the security warning is transmitted through the network. In addition, it is not allowed to use the OBD mode to operate the apparatus until unlocking is performed by the risk removal process.</p>
<p id="p0093" num="0093">Hereinafter, the secure firmware upgrade method according to Embodiment 3 of the present disclosure will be described by taking an example of performing a firmware upgrade on the vehicle in the OBD interface mode.</p>
<p id="p0094" num="0094">As illustrated in <figref idref="f0005">FIG. 5</figref>, a secure firmware upgrade system of the secure firmware upgrade method includes a firmware generation server, a diagnostic tool, an in-vehicle security chip module ESU, and an electronic unit ECU to be written and upgraded. The firmware generation server stores the challenge-end algorithm, i.e., the response algorithm according to Embodiment 3 of the present disclosure, of the challenge response Tag. The in-vehicle security chip module ESU executes steps of the secure firmware upgrade method according to Embodiment 3 of the present disclosure. When there are a number of security verification<!-- EPO <DP n="16"> --> instructions, the response algorithm can be as illustrated in Table 1. In this example, the challenge-end algorithm includes only one security verification instruction AAA. For example, for the firmware of version V1.1, when the security verification instruction AAA is received, the response instruction BBB is fed back.</p>
<p id="p0095" num="0095">In step 1, the firmware generation server transmits the challenge-end algorithm to the in-vehicle security chip module ESU, and the in-vehicle security chip module ESU pre-stores the challenge-end algorithm.</p>
<p id="p0096" num="0096">In step 2, a firmware package for upgrading is generated in the firmware generation server, i.e., the firmware upgrade package according to Embodiment 1 of the present disclosure. The challenge-end algorithm is preconfigured in the upgraded firmware package.</p>
<p id="p0097" num="0097">Since the challenge-end algorithm in this example includes only one security verification instruction AAA, pre-configuring the challenge-end algorithm in the upgraded firmware package is specifically to package a challenge response Tag of a hardcode in the upgraded firmware package. For example, for the firmware of version V1.1, when the security verification instruction AAA is received, the response instruction BBB is fed back.</p>
<p id="p0098" num="0098">In step 3, the diagnostic tool obtains the upgraded firmware package from the firmware generation server, e.g., the firmware package of version V1.1. The diagnostic tool is physically connected to an OBD interface of the vehicle to perform upgrade writing of the firmware of the electronic component ECU.</p>
<p id="p0099" num="0099">In step 4, the diagnostic tool uses the upgraded firmware package to write, based on the writing protocol, the firmware of the electronic unit ECU to be written and upgraded.</p>
<p id="p0100" num="0100">After the firmware is successfully written, the electronic unit ECU runs a new firmware.</p>
<p id="p0101" num="0101">In step 5, the in-vehicle security chip module ESU monitors the writing instruction in the CAN bus or the local area network where the vehicle is located. In response to monitoring the firmware writing instruction for the electronic unit ECU to be written and upgraded, the monitoring mode is entered to monitor the writing progress of the firmware.</p>
<p id="p0102" num="0102">When the in-vehicle security chip module ESU monitors that the electronic unit ECU has completed the writing of the upgraded firmware package, the in-vehicle security chip module ESU initiates the challenge-end algorithm to the electronic unit ECU, and transmits the security verification instruction AAA to the electronic unit ECU.</p>
<p id="p0103" num="0103">In step 6, after the electronic unit ECU receives the security verification instruction AAA transmitted by the in-vehicle security chip module ESU, the electronic unit ECU transmits the response instruction and the version number V1.1 of the upgraded firmware package to the security chip module ESU.</p>
<p id="p0104" num="0104">The in-vehicle security chip module ESU uses the pre-stored challenge-end algorithm to obtain, based on the version number V1.1 of the firmware package transmitted by<!-- EPO <DP n="17"> --> the electronic unit ECU, the predetermined response instruction BBB that is expected to be fed back.</p>
<p id="p0105" num="0105">If the response instruction transmitted by the electronic unit ECU to the in-vehicle security chip module ESU is the predetermined response instruction BBB, the in-vehicle security chip module ESU determines that the response is normal, and the firmware upgrade of the electronic unit ECU is successful. If the response instruction transmitted by the electronic unit ECU to the security chip module ESU is different from the predetermined response instruction BBB, the in-vehicle security chip module ESU determines that the response is abnormal, and a security risk exists in the firmware package written by the electronic unit ECU. In this way, it is determined and recorded that the firmware upgrade is abnormal, and a security warning is transmitted by the security chip module ESU to the vehicle and/or the firmware generation server through the network. In addition, it is forbidden to use the OTA mode to operate the vehicle.</p>
<heading id="h0009"><b>Embodiment 4</b></heading>
<p id="p0106" num="0106">An embodiment of the present disclosure provides a secure firmware upgrade device, which is used to upgrade the firmware of the apparatus, and is especially suitable for the situation where the firmware upgrade is performed in the OBD interface mode. The secure firmware upgrade device may be a vehicle. As illustrated in <figref idref="f0006">FIG. 6</figref>, the secure firmware upgrade device includes a monitoring module, a security verification instruction transmitting module, a response instruction receiving module, and a determining module.</p>
<p id="p0107" num="0107">The monitoring module is configured to receive a firmware writing instruction for an apparatus to be upgraded, and enter a monitoring mode.</p>
<p id="p0108" num="0108">Specifically, the writing instruction in the CAN bus or the local area network where the apparatus is located is monitored. In response to monitoring the firmware writing instruction for the apparatus to be upgraded, the monitoring mode is entered to monitor the writing progress of the firmware.</p>
<p id="p0109" num="0109">The online diagnostic tool receives the firmware upgrade package, uses the secret key and the digital certificate to perform decryption and signature verification on the received firmware upgrade package, and uses the firmware upgrade package to write the firmware in accordance with the writing protocol. The firmware upgrade package is loaded to a corresponding storage module. The version information of the firmware is updated to the version number of the firmware upgrade package. During the packaging process of the firmware upgrade package, the firmware upgrade package is encrypted and added with the digital signature, so as to ensure the security of the firmware upgrade package. The encryption algorithm and the signature algorithm may be any achievable algorithm in the related art, and the present disclosure is not limited to this. After the firmware upgrade package is received, the decryption algorithm and the signature verification are performed. The decryption algorithm<!-- EPO <DP n="18"> --> and the encryption algorithm correspond to each other. The signature verification process corresponds to the signature process.</p>
<p id="p0110" num="0110">Further, the firmware upgrade package is preconfigured with the response algorithm for generating a response instruction corresponding to the security verification instruction. During the packaging process of the firmware upgrade package, the logic implementation program that generates the corresponding response instruction for the security verification instruction is written in advance for subsequent security verification. Different versions of the firmware upgrade packages correspond to the same security verification instruction and different response instructions. There is an one-to-one correspondence between the different versions of the firmware upgrade packages and the security verification instructions and the response instructions.</p>
<p id="p0111" num="0111">For example, for different versions of the firmware upgrade packages, the response algorithm corresponds to the same security verification instruction a or b, and has different response instructions, as illustrated in Table 1. That is, in response to the same security verification instruction a, the response instruction of version VI.0 of the firmware upgrade package is B, the response instruction of version V2.0 of the firmware upgrade package is C, and the response instruction of version V3.0 of the firmware upgrade package is D. In response to the same security verification instruction b, the response instruction of version VI.0 of the firmware upgrade package is X, the response instruction of version V2.0 of the firmware upgrade package is Y, and the response instruction of version V3.0 of the firmware upgrade package is Z. Therefore, there is an one-to-one correspondence between the different versions VI.0, V2.0, V3.0 of the firmware upgrade packages and the security verification instructions and the response instructions, as illustrated in Table 1.</p>
<p id="p0112" num="0112">The security verification instruction transmitting module is configured to transmit, in response to a writing success instruction of the apparatus to be upgraded being monitored by the monitoring module, a security verification instruction to the apparatus to be upgraded.</p>
<p id="p0113" num="0113">Based on the above response algorithm related to the version of the firmware upgrade package, the apparatus needs to transmit the response instruction and the version number of the firmware upgrade package back after receiving the security verification instruction. Under normal circumstances, the apparatus uses the response algorithm preconfigured in the written firmware upgrade package to transmit a corresponding response instruction for the firmware upgrade package of the written version.</p>
<p id="p0114" num="0114">The response instruction receiving module is configured to receive a response instruction transmitted by the apparatus in response to the security verification instruction.</p>
<p id="p0115" num="0115">In an embodiment, the response instruction receiving module is configured to receive a version number of the firmware upgrade package based on the above response algorithm related to the version of the firmware upgrade package, together with the response<!-- EPO <DP n="19"> --> instruction transmitted by the apparatus, such that the predetermined response instruction used by the determining module can be obtained. the predetermined response instruction may be obtained by using, based on the received version number of the firmware upgrade package, the above response algorithm related to the version of the firmware upgrade package, that is, the response instruction associated with the version of the firmware upgrade package and the security verification instruction in Table 1.</p>
<p id="p0116" num="0116">The determining module is configured to transmit, in response to the response instruction being a predetermined response instruction, an upgrade success message to complete a firmware upgrade. Specifically, after receiving the response instruction transmitted by the apparatus, the determining module compares the response instruction transmitted by the apparatus with the predetermined response instruction pre-stored in the response algorithm preconfigured in the firmware upgrade package. In an embodiment, the predetermined response instruction is the above response instruction associated with the version of the firmware upgrade package and the security verification instruction. If the response instruction transmitted by the apparatus is generated by the apparatus based on the response algorithm preconfigured in the written firmware upgrade package, then the response instruction transmitted by the apparatus is identical to the predetermined response instruction pre-stored in the response algorithm preconfigured in the firmware upgrade package, and thus the determining module determines the firmware upgrade to be secure; and when the response instruction transmitted by the apparatus is different from the predetermined response instruction pre-stored in the response algorithm preconfigured in the firmware upgrade package, it is indicated that a security risk exists in the firmware upgrade package written by corresponding firmware. In this way, the determining module determines and records that the firmware upgrade is abnormal, and the security warning is transmitted through the network. In addition, it is not allowed to use the OBD mode to operate the apparatus until unlocking is performed by the risk removal process.</p>
<p id="p0117" num="0117">For example, after the apparatus has completed the writing of the firmware upgrade package VI.0, the security verification instruction a is transmitted to the apparatus. The apparatus generates the response instruction H, and transmits the response instruction H and the version number VI.0 of the firmware upgrade package back.</p>
<p id="p0118" num="0118">According to the pre-stored response algorithm preconfigured in the firmware upgrade package, the response instruction of the firmware upgrade package V1.0 corresponding to the security verification instruction a is B, and the predetermined response instruction is B.</p>
<p id="p0119" num="0119">After receiving the response instruction H transmitted by the apparatus in response to the security verification instruction a and the version number V1.0 of the firmware upgrade package, the determining module compares the response instruction H transmitted by the apparatus with the predetermined response instruction B pre-stored in the response algorithm preconfigured in the firmware upgrade package V1.0. If H=B, the firmware upgrade is<!-- EPO <DP n="20"> --> determined to be secure. If H≠B, it is determined and recorded that the firmware upgrade is abnormal, and the security warning is transmitted through the network. In addition, it is not allowed to use the OBD mode to operate the apparatus until unlocking is performed by the risk removal process.</p>
<p id="p0120" num="0120">An embodiment of the present disclosure also provides an in-vehicle system. The in-vehicle system is built with the secure firmware upgrade device based on an OTA remote upgrade described in Embodiment 2 of the present disclosure and/or the secure firmware upgrade device based on the OBD interface mode described in Embodiment 4 of the present disclosure. The secure firmware upgrade device controls the vehicle to perform a firmware upgrade, thereby ensuring a secure upgrade of the firmware.</p>
<p id="p0121" num="0121">An embodiment of the present disclosure also provides a vehicle. The vehicle includes the above in-vehicle system, such that the vehicle has a function for a secure firmware upgrade.</p>
<p id="p0122" num="0122">An embodiment of the present disclosure also provides a computer-readable storage medium having a computer program stored thereon. The computer program, when executed by a processor, implements steps of the above method.</p>
<p id="p0123" num="0123">An embodiment of the present disclosure also provides a computer device. The computer device includes a memory, a processor, and a computer program stored on the memory and executable on the processor. The processor implements the steps of the above method when executing the program.</p>
<p id="p0124" num="0124">The logic and/or step described in other manners herein or shown in the flow chart, for example, a particular sequence table of executable instructions for realizing the logical function, may be specifically achieved in any computer-readable medium to be used by an instruction execution system, device or equipment (such as a computer-based system, a system including processors or other systems capable of obtaining instructions from the instruction execution system, device and equipment and executing the instructions), or to be used in combination with the instruction execution system, device and equipment. As to the specification, the "computer-readable medium" may be any device adaptive for including, storing, communicating, propagating or transferring programs to be used by or in combination with the instruction execution system, device or equipment.</p>
<p id="p0125" num="0125">More specific examples of the computer-readable medium include but are not limited to: an electronic connection (an electronic device) with one or more wires, a portable computer enclosure (a magnetic device), a Random Access Memory (RAM), a Read-Only Memory (ROM), an Erasable Programmable Read-Only Memory (EPROM or a flash memory), an optical fiber device, and a portable Compact Disk Read-Only Memory (CDROM). In addition, the computer-readable medium may even be a paper or other appropriate medium capable of printing programs thereon, for a reason that, for example, the paper or other<!-- EPO <DP n="21"> --> appropriate medium may be optically scanned and then edited, decrypted or processed with other appropriate methods when necessary to obtain the programs in an electric manner, and then the programs may be stored in computer memories.</p>
<p id="p0126" num="0126">It should be understood that each part of the present disclosure may be realized by the hardware, software, firmware or their combination. In the above embodiments, a plurality of steps or methods may be realized by the software or firmware stored in the memory and executed by an appropriate instruction execution system. For example, if it is achieved by the hardware, likewise in another embodiment, the steps or methods may be realized by one or a combination of the following techniques known in the art: a discrete logic circuit having a logic gate circuit for realizing a logic function of a data signal, an application-specific integrated circuit having an appropriate combination logic gate circuit, a Programmable Gate Array (PGA), a Field Programmable Gate Array (FPGA), etc.</p>
<p id="p0127" num="0127">Reference throughout this specification to "an embodiment," "some embodiments," "an example," "a specific example," or "some examples," means that a particular feature, structure, material, or characteristic described in connection with the embodiment or example is included in at least one embodiment or example of the present disclosure. The appearances of the above phrases in various places throughout this specification are not necessarily referring to the same embodiment or example. Furthermore, the particular features, structures, materials, or characteristics may be combined in any suitable manner in one or more embodiments or examples.</p>
<p id="p0128" num="0128">The embodiments of the present disclosure have been described above. However, the present disclosure is not limited to the above embodiments. Any modification, equivalent replacement, improvement, etc., made within the spirit and principle of the present disclosure shall be included in the protection scope of the present disclosure.</p>
</description>
<claims id="claims01" lang="en"><!-- EPO <DP n="22"> -->
<claim id="c-en-0001" num="0001">
<claim-text>A secure firmware upgrade method, comprising:
<claim-text>performing decryption and signature verification on a received firmware upgrade package;</claim-text>
<claim-text>transmitting, based on the firmware upgrade package, a firmware writing instruction to a corresponding apparatus to be upgraded;</claim-text>
<claim-text>transmitting, based on a writing success instruction received from the apparatus, a security verification instruction to the apparatus;</claim-text>
<claim-text>receiving and verifying a response instruction transmitted by the apparatus in response to the security verification instruction; and</claim-text>
<claim-text>transmitting, in response to the response instruction being a predetermined response instruction, an upgrade success message to complete a firmware upgrade.</claim-text></claim-text></claim>
<claim id="c-en-0002" num="0002">
<claim-text>The secure firmware upgrade method according to claim 1, wherein the firmware upgrade package is preconfigured with a response algorithm for generating the response instruction corresponding to the security verification instruction, different versions of firmware upgrade packages correspond to a same security verification instruction and different response instructions, and there is an one-to-one correspondence between the different versions of the firmware upgrade packages and security verification instructions and response instructions.</claim-text></claim>
<claim id="c-en-0003" num="0003">
<claim-text>The secure firmware upgrade method according to claim 2, wherein said performing decryption and signature verification on the received firmware upgrade package comprises recording, in response to success of the signature verification, a version number of the firmware upgrade package.</claim-text></claim>
<claim id="c-en-0004" num="0004">
<claim-text>The secure firmware upgrade method according to claim 2, wherein said verifying the response instruction comprises:
<claim-text>determining the firmware upgrade to be secure, when the response instruction transmitted by the apparatus is identical to the predetermined response instruction pre-stored in the response algorithm preconfigured in the received firmware upgrade package; and</claim-text>
<claim-text>determining the firmware upgrade to be abnormal, when the response instruction transmitted by the apparatus is different from the predetermined response instruction pre-stored in the response algorithm preconfigured in the received firmware upgrade package.</claim-text></claim-text></claim>
<claim id="c-en-0005" num="0005">
<claim-text>The secure firmware upgrade method according to claim 1, wherein during writing of the firmware upgrade package, security detection is performed on the apparatus to ensure<!-- EPO <DP n="23"> --> security during the firmware upgrade.</claim-text></claim>
<claim id="c-en-0006" num="0006">
<claim-text>The secure firmware upgrade method according to claim 1, further comprising:<br/>
transmitting an abnormality warning in response to the response instruction being inconsistent with the predetermined response instruction.</claim-text></claim>
<claim id="c-en-0007" num="0007">
<claim-text>A secure firmware upgrade device, comprising a firmware upgrade package obtaining module, a firmware writing instruction transmitting module, a security verification instruction transmitting module, a response instruction receiving module, and a determining module, wherein
<claim-text>the firmware upgrade package obtaining module is configured to perform decryption and signature verification on a received firmware upgrade package;</claim-text>
<claim-text>the firmware writing instruction transmitting module is configured to transmit, based on the firmware upgrade package, a firmware writing instruction to a corresponding apparatus to be upgraded;</claim-text>
<claim-text>the security verification instruction transmitting module is configured to transmit, based on a writing success instruction received from the apparatus, a security verification instruction to the apparatus;</claim-text>
<claim-text>the response instruction receiving module is configured to receive a response instruction transmitted by the apparatus in response to the security verification instruction; and</claim-text>
<claim-text>the determining module is configured to transmit, in response to the response instruction being a predetermined response instruction, an upgrade success message to complete a firmware upgrade.</claim-text></claim-text></claim>
<claim id="c-en-0008" num="0008">
<claim-text>A secure firmware upgrade method, comprising:
<claim-text>receiving a firmware writing instruction for an apparatus to be upgraded, and entering a monitoring mode;</claim-text>
<claim-text>transmitting, in response to a writing success instruction of a firmware upgrade package from the apparatus to be upgraded being monitored, a security verification instruction to the apparatus;</claim-text>
<claim-text>receiving and verifying a response instruction transmitted by the apparatus in response to the security verification instruction; and</claim-text>
<claim-text>transmitting, in response to the response instruction being a predetermined response instruction, an upgrade success message to complete a firmware upgrade.</claim-text></claim-text></claim>
<claim id="c-en-0009" num="0009">
<claim-text>The secure firmware upgrade method according to claim 8, wherein the firmware upgrade package is preconfigured with a response algorithm for generating the response<!-- EPO <DP n="24"> --> instruction corresponding to the security verification instruction, different versions of firmware upgrade packages correspond to a same security verification instruction and different response instructions, and there is an one-to-one correspondence between the different versions of the firmware upgrade packages and security verification instructions and response instructions.</claim-text></claim>
<claim id="c-en-0010" num="0010">
<claim-text>The secure firmware upgrade method according to claim 9, wherein a version number of the firmware upgrade package is received together with the response instruction transmitted by the apparatus.</claim-text></claim>
<claim id="c-en-0011" num="0011">
<claim-text>The secure firmware upgrade method according to claim 9, wherein said verifying the response instruction comprises:
<claim-text>determining the firmware upgrade to be secure, when the response instruction transmitted by the apparatus is identical to the predetermined response instruction pre-stored in the response algorithm preconfigured in the received firmware upgrade package; and</claim-text>
<claim-text>determining the firmware upgrade to be abnormal, when the response instruction transmitted by the apparatus is different from the predetermined response instruction pre-stored in the response algorithm preconfigured in the received firmware upgrade package.</claim-text></claim-text></claim>
<claim id="c-en-0012" num="0012">
<claim-text>The secure firmware upgrade method according to claim 9, further comprising transmitting an abnormality warning in response to the response instruction being inconsistent with the predetermined response instruction.</claim-text></claim>
<claim id="c-en-0013" num="0013">
<claim-text>A secure firmware upgrade device, comprising a monitoring module, a security verification instruction transmitting module, a response instruction receiving module, and a determining module, wherein
<claim-text>the monitoring module is configured to receive a firmware writing instruction for an apparatus to be upgraded, and enter a monitoring mode;</claim-text>
<claim-text>the security verification instruction transmitting module is configured to transmit, in response to a writing success instruction of the apparatus being monitored by the monitoring module, a security verification instruction to the apparatus;</claim-text>
<claim-text>the response instruction receiving module is configured to receive a response instruction transmitted by the apparatus in response to the security verification instruction; and</claim-text>
<claim-text>the determining module is configured to transmit, in response to the response instruction being a predetermined response instruction, an upgrade success message to complete a firmware upgrade.</claim-text></claim-text></claim>
<claim id="c-en-0014" num="0014">
<claim-text>An in-vehicle system, configured with the secure firmware upgrade device according<!-- EPO <DP n="25"> --> to claim 7 and/or claim 13.</claim-text></claim>
<claim id="c-en-0015" num="0015">
<claim-text>A vehicle, comprising the in-vehicle system according to claim 14.</claim-text></claim>
</claims>
<drawings id="draw" lang="en"><!-- EPO <DP n="26"> -->
<figure id="f0001" num="1"><img id="if0001" file="imgf0001.tif" wi="133" he="195" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="27"> -->
<figure id="f0002" num="2"><img id="if0002" file="imgf0002.tif" wi="165" he="217" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="28"> -->
<figure id="f0003" num="3"><img id="if0003" file="imgf0003.tif" wi="94" he="233" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="29"> -->
<figure id="f0004" num="4"><img id="if0004" file="imgf0004.tif" wi="133" he="187" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="30"> -->
<figure id="f0005" num="5"><img id="if0005" file="imgf0005.tif" wi="165" he="219" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="31"> -->
<figure id="f0006" num="6"><img id="if0006" file="imgf0006.tif" wi="95" he="210" img-content="drawing" img-format="tif"/></figure>
</drawings>
<search-report-data id="srep" lang="en" srep-office="EP" date-produced=""><doc-page id="srep0001" file="srep0001.tif" wi="153" he="233" type="tif"/><doc-page id="srep0002" file="srep0002.tif" wi="153" he="233" type="tif"/></search-report-data>
</ep-patent-document>
