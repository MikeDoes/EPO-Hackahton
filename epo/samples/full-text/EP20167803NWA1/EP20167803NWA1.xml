<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE ep-patent-document PUBLIC "-//EPO//EP PATENT DOCUMENT 1.5.1//EN" "ep-patent-document-v1-5-1.dtd">
<!-- This XML data has been generated under the supervision of the European Patent Office -->
<ep-patent-document id="EP20167803A1" file="EP20167803NWA1.xml" lang="en" country="EP" doc-number="3888745" kind="A1" date-publ="20211006" status="n" dtd-version="ep-patent-document-v1-5-1">
<SDOBI lang="en"><B000><eptags><B001EP>ATBECHDEDKESFRGBGRITLILUNLSEMCPTIESILTLVFIROMKCYALTRBGCZEEHUPLSKBAHRIS..MTNORSMESMMAKHTNMD..........</B001EP><B005EP>J</B005EP><B007EP>BDM Ver 2.0.12 (4th of August) -  1100000/0</B007EP></eptags></B000><B100><B110>3888745</B110><B120><B121>EUROPEAN PATENT APPLICATION</B121></B120><B130>A1</B130><B140><date>20211006</date></B140><B190>EP</B190></B100><B200><B210>20167803.4</B210><B220><date>20200402</date></B220><B250>en</B250><B251EP>en</B251EP><B260>en</B260></B200><B400><B405><date>20211006</date><bnum>202140</bnum></B405><B430><date>20211006</date><bnum>202140</bnum></B430></B400><B500><B510EP><classification-ipcr sequence="1"><text>A61N   5/10        20060101AFI20200701BHEP        </text></classification-ipcr></B510EP><B520EP><classifications-cpc><classification-cpc sequence="1"><text>A61N   5/103       20130101 FI20210609BHEP        </text></classification-cpc><classification-cpc sequence="2"><text>A61N   5/1001      20130101 LI20210609BHEP        </text></classification-cpc><classification-cpc sequence="3"><text>A61N   5/1031      20130101 LI20210609BHEP        </text></classification-cpc><classification-cpc sequence="4"><text>A61N   5/1077      20130101 LI20210609BHEP        </text></classification-cpc><classification-cpc sequence="5"><text>A61N   5/1038      20130101 LI20210609BHEP        </text></classification-cpc></classifications-cpc></B520EP><B540><B541>de</B541><B542>COMPUTERIMPLEMENTIERTES VERFAHREN ZUR PLANUNG EINER STRAHLENTHERAPIEBEHANDLUNG, COMPUTERPROGRAMMPRODUKT UND COMPUTERSYSTEM ZUR DURCHFÜHRUNG DES VERFAHRENS</B542><B541>en</B541><B542>COMPUTER-IMPLEMENTED METHOD FOR RADIOTHERAPY TREATMENT PLANNING, COMPUTER PROGRAM PRODUCT AND COMPUTER SYSTEM FOR PERFORMING THE METHOD</B542><B541>fr</B541><B542>PROCÉDÉ MIS EN  UVRE PAR ORDINATEUR POUR LA PLANIFICATION D'UN TRAITEMENT DE RADIOTHÉRAPIE, PRODUIT PROGRAMME INFORMATIQUE ET SYSTÈME INFORMATIQUE POUR LA MISE EN  UVRE DU PROCÉDÉ</B542></B540><B590><B598>1c</B598></B590></B500><B700><B710><B711><snm>RaySearch Laboratories AB</snm><iid>101733764</iid><irf>PA202002B</irf><adr><str>P.O. Box 3297</str><city>103 65 Stockholm</city><ctry>SE</ctry></adr></B711></B710><B720><B721><snm>ANDERSSON, Björn</snm><adr><str>Murargatan 4A</str><city>SE-754 37 Uppsala</city><ctry>SE</ctry></adr></B721><B721><snm>Engwall, Erik</snm><adr><str>Hindersmässgränd 7</str><city>129 44 Hägersten</city><ctry>SE</ctry></adr></B721><B721><snm>Fredriksson, Albin</snm><adr><str>Tideliusgatan 43</str><city>11869 Stockholm</city><ctry>SE</ctry></adr></B721><B721><snm>Eriksson, Kjell</snm><adr><str>Älgvägen 5</str><city>74651 Bålsta</city><ctry>SE</ctry></adr></B721></B720></B700><B800><B840><ctry>AL</ctry><ctry>AT</ctry><ctry>BE</ctry><ctry>BG</ctry><ctry>CH</ctry><ctry>CY</ctry><ctry>CZ</ctry><ctry>DE</ctry><ctry>DK</ctry><ctry>EE</ctry><ctry>ES</ctry><ctry>FI</ctry><ctry>FR</ctry><ctry>GB</ctry><ctry>GR</ctry><ctry>HR</ctry><ctry>HU</ctry><ctry>IE</ctry><ctry>IS</ctry><ctry>IT</ctry><ctry>LI</ctry><ctry>LT</ctry><ctry>LU</ctry><ctry>LV</ctry><ctry>MC</ctry><ctry>MK</ctry><ctry>MT</ctry><ctry>NL</ctry><ctry>NO</ctry><ctry>PL</ctry><ctry>PT</ctry><ctry>RO</ctry><ctry>RS</ctry><ctry>SE</ctry><ctry>SI</ctry><ctry>SK</ctry><ctry>SM</ctry><ctry>TR</ctry></B840><B844EP><B845EP><ctry>BA</ctry></B845EP><B845EP><ctry>ME</ctry></B845EP></B844EP><B848EP><B849EP><ctry>KH</ctry></B849EP><B849EP><ctry>MA</ctry></B849EP><B849EP><ctry>MD</ctry></B849EP><B849EP><ctry>TN</ctry></B849EP></B848EP></B800></SDOBI>
<abstract id="abst" lang="en">
<p id="pa01" num="0001">A computer-based method of optimizing a radiotherapy treatment plan for a patient is proposed, wherein a treatment plan to be provided by one radiation set is optimized taking into account a previously delivered dose delivered by a different radiation set. One of the radiation sets is external beam radiotherapy and the other is brachytherapy.
<img id="iaf01" file="imgaf001.tif" wi="70" he="65" img-content="drawing" img-format="tif"/></p>
</abstract>
<description id="desc" lang="en"><!-- EPO <DP n="1"> -->
<heading id="h0001"><u>Technical Field</u></heading>
<p id="p0001" num="0001">The present invention relates to a computer-implemented method for radiotherapy treatment planning, and to a computer program product and an apparatus for carrying out such a method. In particular, the invention relates to treatment planning for radiotherapy that involves both external beam radiation therapy and brachytherapy for the same patient.</p>
<heading id="h0002"><u>Background</u></heading>
<p id="p0002" num="0002">Most radiotherapy treatment is provided as external radiation that is delivered to a patient from an external source, known as external beam radiotherapy or EBRT. This is normally delivered in a number of fractions, for example, 15, 30 or more fractions. Alternatively, radiation may be delivered from a source that is placed within the patient. This is known as brachytherapy and involves placing one more needles or other type of equipment within the target in the patient to expose it to radiation from within. This is normally performed in a smaller number of fractions, for example, 1 or 3.</p>
<p id="p0003" num="0003">For EBRT treatment, planning is currently mostly performed as an inverse planning process in an optimization treatment planner. The aim is normally to achieve a minimum dose, or an even dose, over the whole target. Brachytherapy or BT planning requires the placement of equipment for providing radiation within the target, either physically or in a virtual environment and the dose is normally developed in a forward planning process in which the positions of the equipment and the dose resulting from it is determined. In low dose rate BT, one or more sources, known as seeds, are implanted into the target, and normally remain there for the foreseeable future. On the other hand, in high dose rate BT and pulsed dose rate BT, the radiation is delivered by radioactive sources moving through hollow channels in the implanted equipment, which consists of e.g. needles, catheters and applicators. Normally, the BT<!-- EPO <DP n="2"> --> dose distribution is not uniform but is instead concentrated around the implanted equipment.</p>
<p id="p0004" num="0004">It is known in the art to combine EBRT and brachytherapy in the same patient. Typically, the EBRT fractions are delivered first and then the brachytherapy, but the opposite order is also possible. During the first treatment, the patient geometry will normally change. Also, the equipment inserted into the patient for brachytherapy will change the shape of the target and the surrounding tissue. For both these reasons, the two modalities will be delivered to different patient geometries. In the cases where both brachytherapy and external radiation treatment are used on the same patient, traditionally two separate treatments plans are developed, one for the EBRT portion of the treatment, and one for the brachytherapy portion of the treatment. These are typically based on a total dose and a predetermined division of the dose between the different types of treatment. For example, a total dose of 80 Gy may be set, where EBRT treatment is to contribute 60 Gy and brachytherapy the remaining 20 Gy.</p>
<p id="p0005" num="0005">It is an object of the present invention to provide an improved planning method for a radiotherapy treatment involving both EBRT and brachytherapy.</p>
<heading id="h0003"><u>Summary of the invention</u></heading>
<p id="p0006" num="0006">The invention relates to a computer-based method of optimizing a radiotherapy treatment plan for a patient, comprising the steps of
<ol id="ol0001" compact="compact" ol-style="">
<li>a) determining, based on at least a first medical image of the patient, a dose previously delivered to the patient by means of a first radiation set,</li>
<li>b) obtaining a first optimization problem comprising an optimization function designed to optimize the dose distribution resulting from the second radiation set in dependence of dose criteria set for a total dose and of the previously delivered dose, the total dose being the dose resulting from the second radiation set and the previously delivered dose,</li>
<li>c) optimizing the treatment plan for delivering radiotherapy by the second radiation set by means of the first optimization problem, wherein the<!-- EPO <DP n="3"> --> optimization function is an objective function or a constraint and one of the first and the second radiation set is brachytherapy and the other is external beam radiation therapy.</li>
</ol></p>
<p id="p0007" num="0007">This will improve the planning of the treatment to be delivered by the second radiation set by taking into account treatment already delivered by the first radiation set. The previously delivered dose may be estimated or calculated by means of any suitable method.</p>
<p id="p0008" num="0008">In preferred embodiments, the first optimization problem comprises an optimization function designed to optimize the dose distribution resulting from the second radiation set to match the difference between the desired total dose distribution as expressed by the dose criteria and the previously delivered dose. This will provide an actual total dose resulting from the combined dose delivered by both radiation sets, that is a good match for the desired total dose distribution.</p>
<p id="p0009" num="0009">The dose criteria are preferably based on at least an earlier medical image taken before the delivery of the first radiation set.</p>
<p id="p0010" num="0010">According to preferred embodiments, the method further comprises the following steps, before step a):
<ul id="ul0001" list-style="none" compact="compact">
<li>d) obtaining an initial optimization problem comprising an optimization function designed to optimize the total dose distribution as a combination of a first dose distribution to be provided by the first radiation set and a second dose distribution to be provided by the second radiation set</li>
<li>e) optimizing the treatment plan as a combination of the first and the second radiation set by means of the initial optimization problem.</li>
</ul></p>
<p id="p0011" num="0011">This will further improve the planning by considering both radiation sets already when planning for the dose to be delivered by the first radiation set.<!-- EPO <DP n="4"> --></p>
<p id="p0012" num="0012">The at least one first medical image may comprise at least one image taken of the patient after delivery of the first portion. This will provide the most correct information on the actual patient geometry.</p>
<p id="p0013" num="0013">Alternatively, or in addition, the at least one first medical image may comprise at least one simulated image based on an estimate of patient's geometry after delivery of the portion. This is suitable if, for some reason, it is not feasible to take a new image of the patient after delivery of the portion, or with the brachytherapy equipment inserted.</p>
<p id="p0014" num="0014">In preferred embodiments, the method comprises deforming at least one of the doses delivered by the first and second radiation set, respectively, to obtain a common geometry for the treatment portions and accumulating them using a biological model, the optimization function being a set of penalties on the accumulated doses and on the radiation set-specific dose from the second radiation set. Normally, the dose of the second radiation set will be deformed to the first medical image.</p>
<p id="p0015" num="0015">Preferably, robust planning is used to take into account uncertainties in the placement of brachytherapy equipment, in the EBRT delivery, and/or in determined delivered dose. how to implement robust planning is known in the art.</p>
<p id="p0016" num="0016">The invention also relates to a computer program product comprising computer-readable code means, which when run in a computer is arranged to make the computer perform a method according to any of the embodiments above. The computer program product may be stored on any suitable type of non-transitory storage medium.</p>
<p id="p0017" num="0017">The invention also relates to a computer system comprising a processor and at least one program memory, characterized in that the program memory holds a computer program as defined above.</p>
<p id="p0018" num="0018">In preferred embodiments, the invention involves planning of brachytherapy planning in which the accumulated dose already delivered to the patient by some other modality is also taken into account. This means that deviations from the<!-- EPO <DP n="5"> --> planned dose to the target may be compensated for, but also that a too high dose to an organ at risk may be compensated for by changing the brachytherapy treatment plan accordingly.</p>
<heading id="h0004"><u>Brief description of drawings</u></heading>
<p id="p0019" num="0019">The invention will be described in more detail in the following, by way of examples and with reference to the appended drawings, in which
<ul id="ul0002" list-style="none" compact="compact">
<li><figref idref="f0001">Figures 1a, 1b and 1c</figref> are sections through a medical image of a patient.</li>
<li><figref idref="f0001">Figure 2</figref> is a flow chart of an general embodiment of the method.</li>
<li><figref idref="f0002">Figure 3</figref> is a flow chart of a more specific embodiment of the method including EBRT followed by BT.</li>
<li><figref idref="f0002">Figure 4</figref> is a flow chart of a second more specific embodiment of the method including BT followed by EBRT.</li>
<li><figref idref="f0002">Figure 5</figref> is a schematic overview of a computer system in which embodiments of the invention may be implemented</li>
</ul></p>
<heading id="h0005"><u>Detailed description of embodiments</u></heading>
<p id="p0020" num="0020">External beam radiation treatment, EBRT, involves providing radiation to the patient in the form of a beam delivered from the outside. The radiation may be any type of radiation, including photons, electrons, protons or other ions. Brachytherapy, BT, involves the insertion of some type of equipment into the target within the patient, and using said equipment to provide the radiation from one or more points within the target. This equipment may include a number of small needles and/or catheters,one or more larger applicators, one or more seeds, or any combination of the different types of equipment. Depending on the number and size of the devices, the target as well as the surrounding patient geometry will be deformed.</p>
<p id="p0021" num="0021">Due to the different natures of the two radiation sets, the planning of EBRT and BT use different treatment parameters. Treatment parameters for EBRT treatment include beam and beam limiting device configurations. Treatment<!-- EPO <DP n="6"> --> parameters for BT treatment include variables such as equipment position and dwell times. Each radiation set typically involves radiation being delivered in one or more fractions, typically but not necessarily, a higher number for EBRT than for BT, which may even be delivered in one single fraction.</p>
<p id="p0022" num="0022">As discussed above, inverse planning using an optimization problem is common for EBRT planning but is not traditionally used for brachytherapy. The dose distribution EBRT could be expressed as <maths id="math0001" num="(1)"><math display="block"><mrow><msub><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">EBRT</mi></msub><mo>=</mo><msub><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">EBRT</mi></msub><mfenced><msub><mi mathvariant="bold-italic">x</mi><mi mathvariant="italic">EBRT</mi></msub></mfenced></mrow></math><img id="ib0001" file="imgb0001.tif" wi="77" he="7" img-content="math" img-format="tif"/></maths> and the dose distribution for brachytherapy could be expressed as <maths id="math0002" num="(2)"><math display="block"><mrow><msub><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">BT</mi></msub><mo>=</mo><msub><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">BT</mi></msub><mfenced><msub><mi mathvariant="bold-italic">x</mi><mi mathvariant="italic">BT</mi></msub></mfenced></mrow></math><img id="ib0002" file="imgb0002.tif" wi="49" he="7" img-content="math" img-format="tif"/></maths> where <i><b>x</b><sub>EBRT</sub></i>, <i><b>x</b><sub>BT</sub></i> are treatment parameters for the respective treatment form.</p>
<p id="p0023" num="0023">The invention relates to simultaneous optimization of the treatment parameters for EBRT treatment and BT treatment. This means that the optimization problem can be expressed as Eq. (3) <maths id="math0003" num="(3)"><math display="block"><mrow><munder><mi>min</mi><mrow><msub><mi mathvariant="bold-italic">x</mi><mi mathvariant="italic">EBRT</mi></msub><mo>,</mo><msub><mi mathvariant="bold-italic">x</mi><mi mathvariant="italic">BT</mi></msub></mrow></munder><mi>f</mi><mfenced separators=","><msub><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">EBRT</mi></msub><msub><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">BT</mi></msub></mfenced></mrow></math><img id="ib0003" file="imgb0003.tif" wi="68" he="10" img-content="math" img-format="tif"/></maths> where <i><b>x</b><sub>EBRT</sub></i> are the treatment parameters for the EBRT subportion of the treatment and <i><b>x</b><sub>BT</sub></i> are the treatment parameters for the BT subportion of the treatment. <i><b>d</b><sub>EBRT</sub></i> and <i><b>d</b><sub>BT</sub></i> are the doses for the EBRT subportion and the BT subportion, respectively. Instead of the dose d, some other parameter related to the respective subportion may be used.</p>
<p id="p0024" num="0024">Typically, the optimization includes deforming the doses to a common geometry and accumulating them using a biological model, the objective function being a set of penalties on the accumulated doses and on the radiation set-specific doses.</p>
<p id="p0025" num="0025"><figref idref="f0001">Figures 1a, 1b and 1c</figref> are simplified examples of medical images taken at different points in the inventive procedure, as will be discussed in more detail in connection with <figref idref="f0001">Figure 2. Figure 1a</figref> is a section 11 through a schematical medical<!-- EPO <DP n="7"> --> image of a patient's abdomen, with a target 13 and an organ at risk 15 pointed out, to be used for treatment planning according to embodiments of the invention. <figref idref="f0001">Figure 1b</figref> is a corresponding section 11' through a medical image of the same patient after a first type of treatment, illustrating schematically the changes that this treatment may have caused to the patient's geometry. As will be understood, the target 13 has shrunk because of the treatment, which is usually the desired result. <figref idref="f0001">Figure 1c</figref> is the corresponding section 11" of a medical image of the same patient with needles inserted into the target for providing brachytherapy to the patient. The needles are shown as small dots 17 within the target. As can be seen, this also changes the geometry of the target 13" and of the region of the patient surrounding the target.</p>
<p id="p0026" num="0026"><figref idref="f0001">Figure 2</figref> is a flow chart of an overall method according to an embodiment of the invention.</p>
<p id="p0027" num="0027">In a first step S21, an image of relevant portion of the patient, such as the one discussed in connection with <figref idref="f0001">Figures 1a - 1c</figref> is obtained. In step S22, dose criteria for a total dose distribution to be delivered as a combined plan including both EBRT and brachytherapy is determined.</p>
<p id="p0028" num="0028">In step S23, the optimization problem is defined, based on the image or images and dose criteria for the desired total dose. Dose criteria are set as common in the art. They typically include a minimum dose for all voxels of the target and often a maximum dose for one or more organs at risk. For example, the dose criteria may specify a total dose of at least 60 Gy in each target voxel, and that at most 30% of an organ at risk is subjected to a total dose of more than 40 Gy. Dose criteria may also include a partial or complete dose distribution. In S24 the treatment plan is optimized using the optimization problem. The optimization problem includes an objective function such as function (3) above.</p>
<p id="p0029" num="0029">In step S25, a part of the treatment plan is delivered to the patient and in step S26 the accumulated dose delivered to the patient from the part of the treatment plan is estimated. The accumulated dose may be determined in any suitable way. Methods of doing this are well known in the art and are typically based on at least one<!-- EPO <DP n="8"> --> medical image, for example a number of fraction images taken throughout the delivery of the first portion of the treatment plan.</p>
<p id="p0030" num="0030">In step S27, a new image of the same portion of the patient is obtained, to see the new patient geometry after the partial delivery in step S25. If applicable, other modifications may be made, such as the insertion of brachytherapy equipment and an image reflecting the resulting geometry may be taken. The new image may be an image taken of the patient at this stage, or a synthetic image based on estimates of the new patient geometry.</p>
<p id="p0031" num="0031">In step S28 the remainder of the treatment plan is optimized again, using an inverse planning method based on an optimization function that will be discussed in more detail below. The planning takes into account the accumulated dose of the partial delivery that has been performed previously. The optimization problem should then include an objective function according to the following: <maths id="math0004" num="(4)"><math display="block"><mrow><munder><mi>min</mi><mrow><msub><mi mathvariant="bold-italic">x</mi><mi mathvariant="italic">BT</mi></msub></mrow></munder><mspace width="1em"/><mi mathvariant="italic">g</mi><mrow><mfenced separators=","><msubsup><mi mathvariant="bold-italic">d</mi><mrow><mi mathvariant="italic">RS</mi><mn>1</mn></mrow><mi mathvariant="italic">delivered</mi></msubsup><msub><mi mathvariant="bold-italic">d</mi><mrow><mi mathvariant="italic">RS</mi><mn>2</mn></mrow></msub></mfenced></mrow></mrow></math><img id="ib0004" file="imgb0004.tif" wi="77" he="10" img-content="math" img-format="tif"/></maths> where <maths id="math0005" num=""><math display="inline"><mrow><msubsup><mi mathvariant="bold-italic">d</mi><mrow><mi mathvariant="italic">RS</mi><mn>1</mn></mrow><mi mathvariant="italic">delivered</mi></msubsup></mrow></math><img id="ib0005" file="imgb0005.tif" wi="22" he="9" img-content="math" img-format="tif" inline="yes"/></maths> is the delivered dose from the first radiation set, determined in step S26 and <i><b>d</b></i><sub><i>RS</i>2</sub> is the dose to be delivered by the second radiation set.</p>
<p id="p0032" num="0032">where g is another objective function, which may or may not be equal to f and the delivered dose from the first radiation set over all fractions (either measured or estimated) is used a as a fixed background dose for the planning for the second radiation set.</p>
<p id="p0033" num="0033">In step S28, the reoptimized remainder of the plan is delivered to the patient.</p>
<p id="p0034" num="0034"><figref idref="f0002">Figure 3</figref> is a flow chart of an embodiment of the inventive method in which the total treatment plan includes first EBRT treatment and then BT treatment. The input data S31 to this plan include a current medical image of the patient, dose criteria for a desired dose distribution, and a prediction model of the patient geometry after the EBRT treatment. The prediction model may be an adjusted or synthetic<!-- EPO <DP n="9"> --> medical image. The input data may also include a prediction model of the patient geometry after the EBRT treatment with the EB equipment included. The medical images may be CT images, or any other suitable image modality, such as MR or ultrasound images.</p>
<p id="p0035" num="0035">In a method step S32 the optimization problem is obtained based on the dose criteria and the input data. The optimization problem includes an objective function according to Eq. (3) based on the total dose of both the EBRT and the BT subportions of the treatment, and optionally the dose to be delivered for each radiation set. This typically includes deforming at least one of the doses <i><b>d</b><sub>EBRT</sub></i> and <i><b>d</b><sub>BT</sub></i> to a common geometry and accumulating them using a suitable biological model. This may include setting a combination of penalties on the accumulated doses and on the specific doses. Models for establishing a common geometry are known, typically including deformable registration of the images. Models for determining the accumulated dose are also known to the skilled person. For example, the biological concept EQD2 may be applied to give an estimate of the total effective dose.</p>
<p id="p0036" num="0036">In a subsequent method step S33, optimization is performed based on the common geometry and accumulated dose. The optimization problem includes an objective function according to Eq. (3) above. As will be understood, the objective function could also be extended to depend on the treatment parameters and the optimization problem may also include constraints depending on dose or treatment parameters. The output S34 from the optimization step S33 is a total treatment plan including one subportion for each radiation set, that is one EBRT subportion and one BT subportion. Each subportion includes the portion of the dose to be delivered by the corresponding radiation set and the number of fractions in which to deliver it.</p>
<p id="p0037" num="0037">The EBRT subportion of the treatment plan is then delivered to the patient, in a step S35 and the actual delivered dose from this delivery is determined or estimated in a step S36. Preferably, the situation after the EBRT delivery is assessed and used to refine the BT subportion of the treatment plan as outlined in the following steps.<!-- EPO <DP n="10"> --></p>
<p id="p0038" num="0038">In step S37, updated images of the patient after the EBRT treatment are obtained. These include a new image of the patient to account for the geometric changes that occurred during EBRT treatment. It also includes an image of the patient with the BT equipment inserted, since the BT equipment will cause an amount of deformation of the target and the surrounding patient geometry depending on the type of equipment.</p>
<p id="p0039" num="0039">In a subsequent step S38, the BT subportion of the treatment is reoptimized taking into account the delivered dose from step S35 and the new images obtained in step S37. The optimization problem in this case includes an objective function expressed as Eq. (2) below: <maths id="math0006" num="(5)"><math display="block"><mrow><munder><mi>min</mi><mrow><msub><mi mathvariant="bold-italic">x</mi><mi mathvariant="italic">BT</mi></msub></mrow></munder><mspace width="1em"/><mi mathvariant="italic">g</mi><mrow><mfenced separators=","><msubsup><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">EBRT</mi><mi mathvariant="italic">delivered</mi></msubsup><msub><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">BT</mi></msub></mfenced></mrow></mrow></math><img id="ib0006" file="imgb0006.tif" wi="77" he="10" img-content="math" img-format="tif"/></maths> where <maths id="math0007" num=""><math display="inline"><mrow><msubsup><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">EBRT</mi><mi mathvariant="italic">delivered</mi></msubsup></mrow></math><img id="ib0007" file="imgb0007.tif" wi="23" he="9" img-content="math" img-format="tif" inline="yes"/></maths> is the delivered dose determined in step S35.</p>
<p id="p0040" num="0040">The output from step S38 is a new optimized BT treatment plan S39, which is preferably delivered to the patient.</p>
<p id="p0041" num="0041">As discussed for <figref idref="f0001">Figure 2</figref>, the steps S36-S39 may be performed without first performing the preceding steps, that is, the BT plan may take previous EBRT treatment into account even if there was no initial combined planning of the two.</p>
<p id="p0042" num="0042"><figref idref="f0002">Figure 4</figref> is a flowchart of a method in which the first radiation set to be delivered is the BT. The input data S41 to this plan include a current medical image of the patient, and a medical image of the patient with the BT equipment inserted, and dose criteria for a desired dose distribution. Preferably, the input data also include a prediction model of the patient geometry after the BT treatment. The medical images may be CT images, or any other suitable image modality, such as MR or ultrasound images.</p>
<p id="p0043" num="0043">In a method step S42 the optimization problem is defined in a manner similar to step S32. When the BT dose portion is delivered first, the image of the patient with the BT equipment inserted is already available as input. These images can<!-- EPO <DP n="11"> --> be deformably registered to provide a geometric correspondence between the treatment geometries. As in step S32, the doses <i><b>d</b><sub>EBRT</sub></i> and <i><b>d</b><sub>BT</sub></i> are deformed to a common geometry and accumulated using a suitable biological model. This may include setting a combination of penalties on the accumulated doses and on the specific doses. Models for establishing a common geometry are known, typically including deformable registration of the images. Models for determining the accumulated dose are also known to the skilled person.</p>
<p id="p0044" num="0044">In a subsequent method step S43, optimization is performed based on the common geometry and accumulated dose. The optimization problem includes an objective function according to Eq. (3) above. As will be understood, the optimization problem could also be extended to depend on the treatment parameters and also include other objective functions and/or constraints. The output S44 from the optimization step S43 is a total treatment plan including one subportion for each radiation set, that is one BT subportion and one EBRT subportion.</p>
<p id="p0045" num="0045">The BT subportion of the treatment plan is then delivered to the patient, in a step S45, and the actual delivered dose from this delivery is determined or estimated in a step S46. Preferably, the situation after the BT delivery is assessed and used to refine the EBRT subportion of the treatment plan as outlined in the following steps.</p>
<p id="p0046" num="0046">In step S47, an updated image of the patient after the BT treatment is obtained, to account for the geometric changes that occurred during BT treatment.</p>
<p id="p0047" num="0047">In a subsequent step S48, the EBRT subportion of the treatment is reoptimized taking into account the delivered dose from step S45 and the new image obtained in step S47. The optimization problem in this case includes an objective function expressed as Eq. (2) below: <maths id="math0008" num="(6)"><math display="block"><mrow><munder><mi>min</mi><mrow><msub><mi mathvariant="bold-italic">x</mi><mi mathvariant="italic">BT</mi></msub></mrow></munder><mspace width="1em"/><mi mathvariant="italic">g</mi><mrow><mfenced separators=","><msubsup><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">BT</mi><mi mathvariant="italic">delivered</mi></msubsup><msub><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">EBRT</mi></msub></mfenced></mrow></mrow></math><img id="ib0008" file="imgb0008.tif" wi="77" he="10" img-content="math" img-format="tif"/></maths> where <maths id="math0009" num=""><math display="inline"><mrow><msubsup><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">BT</mi><mi mathvariant="italic">delivered</mi></msubsup></mrow></math><img id="ib0009" file="imgb0009.tif" wi="23" he="10" img-content="math" img-format="tif" inline="yes"/></maths> is the delivered dose determined in step S45.<!-- EPO <DP n="12"> --></p>
<p id="p0048" num="0048">The output from step S48 is a new optimized EBRT treatment plan S49, which is preferably delivered to the patient.</p>
<p id="p0049" num="0049">As discussed for <figref idref="f0001">Figures 2</figref> and <figref idref="f0002">3</figref>, the steps S46-S49 may be performed without first performing the preceding steps, that is, the EBRT plan may take previously delivered BT treatment into account even if there was no initial combined planning of the two.</p>
<p id="p0050" num="0050">It would also be possible to create a plan where the BT and EBRT fractions were not given as two consecutive sub-portions and instead the BT fractions were distributed between the EBRT fractions. In this type of treatment, the subportion or subportions of the treatment that have not yet been delivered can be reoptimized taking into account the delivered dose. Both the delivered and the nondelivered subportion of the treatment will typically be a combination of BT and EBRT. The optimization in this case includes an objective function expressed as Eq. (7) below <maths id="math0010" num="(7)"><math display="block"><mrow><munder><mi>min</mi><mrow><msub><mi>x</mi><mi mathvariant="italic">EBRT</mi></msub><msub><mi>x</mi><mi mathvariant="italic">BT</mi></msub></mrow></munder><mspace width="1em"/><mi mathvariant="italic">g</mi><mrow><mfenced separators=",,,"><msubsup><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">BT</mi><mi mathvariant="italic">delivered</mi></msubsup><msubsup><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">EBRT</mi><mi mathvariant="italic">delivered</mi></msubsup><msub><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">BT</mi></msub><msub><mi mathvariant="bold-italic">d</mi><mi mathvariant="italic">EBRT</mi></msub></mfenced></mrow></mrow></math><img id="ib0010" file="imgb0010.tif" wi="100" he="12" img-content="math" img-format="tif"/></maths></p>
<p id="p0051" num="0051">In all of the above methods, the simultaneous optimization should be performed with some care, to ensure that the individual doses of each radiation set are still satisfactory on their own. One possible adverse effect of co-optimization would be an EBRT dose with cold spots in the targets that are to be later filled in by the BT dose. This could be mitigated by incorporating robustness into the model against e.g. the uncertainty of equipment positioning and the deforming effect of the equipment. Treatment-specific objective functions are also a possibility (analogously to the current beam set-specific objective functions).</p>
<p id="p0052" num="0052">As with any radiotherapy treatment planning there will be sources of uncertainty, including the placement of the patient, the positioning of the BT equipment and the estimated delivered dose. To compensate for this, robust planning may be used. In particular, the deformation between the images will result in an approximate accumulated dose, the quality of which depends on the accuracy of the deformable registration. To avoid over-optimizing on an accumulated dose that differs<!-- EPO <DP n="13"> --> from the dose that will actually be delivered, methods for robust planning over a representation of the uncertainty could be employed. Various degrees of refinement could be used, for example:
<ul id="ul0003" list-style="bullet">
<li>Margins could be applied, as an ITV over predicted images, or just smearing of the regions to be treated.</li>
<li>Robust planning using scenarios generated as rigid shifts of the patient geometry, may be applied, independently for each of the radiation sets.</li>
<li>Robust planning using scenarios generated by multiple deformable registrations could be applied. In the case where the EBRT partial dose is delivered before the BT partial dose, this would involve utilizing multiple predictions. In the case where the BT partial dose is delivered before the EBRT partial dose, this would involve or using perturbations of the registrations between the acquired images. The deformations can also come from anatomical changes during EBRT, e.g. tumor shrinkage.</li>
</ul></p>
<p id="p0053" num="0053">The method according to embodiments of the invention may also be combined with multi-criteria optimization. In this case the navigation could take place on several fronts, with several trade-off objectives targeting either the total dose or either of the individual treatment doses.</p>
<p id="p0054" num="0054"><figref idref="f0002">Fig. 5</figref> is a schematic representation of a computer system in which the inventive method may be performed. A computer 31 comprises a processor 33, connected to a first and a second data memory 34, 35 and a program memory 36. Preferably, one or more user input means 38, 39 are also present, in the form of a keyboard, a mouse, a joystick, voice recognition means or any other available user input means. The user input means may also be arranged to receive data from an external memory unit.</p>
<p id="p0055" num="0055">The first data memory 34 comprises necessary data for performing the method, such as the necessary images. The second data memory 35 holds data related to one or more current patients for which treatment plans are to be developed. The<!-- EPO <DP n="14"> --> program memory 36 holds a computer program arranged to make the computer perform the method steps, for example, as discussed in connection with any of the <figref idref="f0001">Figures 2</figref>, <figref idref="f0002">3 and 4</figref>.</p>
<p id="p0056" num="0056">As will be understood, the data memories 34, 35 as well as the program memory 36 are shown and discussed schematically. There may be several data memory units, each holding one or more different types of data, or one data memory holding all data in a suitably structured way, and the same holds for the program memories. One or more of the components may be found in a cloud environment, as long as the components are able to communicate with each other.</p>
</description>
<claims id="claims01" lang="en"><!-- EPO <DP n="15"> -->
<claim id="c-en-0001" num="0001">
<claim-text>A computer-based method of optimizing a radiotherapy treatment plan for delivering radiotherapy to a patient by means of a second radiation set, comprising the steps of
<claim-text>a) determining, based on at least a first medical image of the patient, a dose previously delivered to the patient by means of a first radiation set,</claim-text>
<claim-text>b) obtaining a first optimization problem comprising an optimization function designed to optimize the dose distribution resulting from the second radiation set in dependence of dose criteria set for a total dose and of the previously delivered dose, the total dose being the dose resulting from the second radiation set and the previously delivered radiation set,</claim-text>
<claim-text>c) optimizing the treatment plan for delivering radiotherapy by the second radiation set by means of the optimization problem, wherein the optimization function is an objective function or a constraint and one of the first and the second radiation set is brachytherapy and the other is external beam radiation therapy.</claim-text></claim-text></claim>
<claim id="c-en-0002" num="0002">
<claim-text>A computer-based method according to claim 1, wherein the first optimization problem comprises an optimization function designed to optimize the dose distribution resulting from the second radiation set to match the difference between the desired total dose distribution and the previously delivered dose.</claim-text></claim>
<claim id="c-en-0003" num="0003">
<claim-text>A computer-based method according to claim 1 or 2, wherein the dose criteria are set based on at least an earlier medical image taken before the delivery of the first radiation set.</claim-text></claim>
<claim id="c-en-0004" num="0004">
<claim-text>A computer-based method according to any one of the preceding claims, further comprising the following steps, before step a):
<claim-text>d) obtaining an initial optimization problem comprising an objective function designed to optimize the total dose distribution as a combination of a first dose distribution to be provided by the first radiation set and a second dose distribution to be provided by the second radiation set<!-- EPO <DP n="16"> --></claim-text>
<claim-text>e) optimizing the treatment plan as a combination of the first and the second radiation set by means of the initial optimization problem.</claim-text></claim-text></claim>
<claim id="c-en-0005" num="0005">
<claim-text>A computer-based method according to any one of the preceding claims, wherein the first optimization problem is obtained based on a second medical image.</claim-text></claim>
<claim id="c-en-0006" num="0006">
<claim-text>A method according to any one of the preceding claims, wherein the second radiation set is brachytherapy and the second medical image includes brachytherapy equipment applied to the patient.</claim-text></claim>
<claim id="c-en-0007" num="0007">
<claim-text>A method according to any one of the preceding claims, wherein the at least one first medical image comprises at least one image taken of the patient after delivery of the first radiation set.</claim-text></claim>
<claim id="c-en-0008" num="0008">
<claim-text>A method according to any one of the preceding claims, wherein the at least one first image comprises at least one simulated image based on an estimate of patient's geometry after delivery of the first radiation set.</claim-text></claim>
<claim id="c-en-0009" num="0009">
<claim-text>A method according to any one of the preceding claims, further comprising the steps of deforming the dose of the second radiation set to the geometry of the first medical image and accumulating the doses using a biological model, the objective function being a set of penalties on the accumulated doses and on the radiation set-specific dose from the second radiation set.</claim-text></claim>
<claim id="c-en-0010" num="0010">
<claim-text>A method according to any one of the preceding claims, wherein robust planning is used to take into account uncertainties brachytherapy delivery, in the EBRT delivery, and/or in determined delivered dose.</claim-text></claim>
<claim id="c-en-0011" num="0011">
<claim-text>A computer program product comprising computer-readable code means, which when run in a computer is arranged to make the computer perform a method according to any one of the preceding claims.<!-- EPO <DP n="17"> --></claim-text></claim>
<claim id="c-en-0012" num="0012">
<claim-text>A computer system comprising a processor an at least one program memory, <b>characterized in that</b> the program memory holds a computer program product according to claim 11.</claim-text></claim>
</claims>
<drawings id="draw" lang="en"><!-- EPO <DP n="18"> -->
<figure id="f0001" num="1a,1b,1c,2"><img id="if0001" file="imgf0001.tif" wi="148" he="233" img-content="drawing" img-format="tif"/></figure><!-- EPO <DP n="19"> -->
<figure id="f0002" num="3,4,5"><img id="if0002" file="imgf0002.tif" wi="142" he="233" img-content="drawing" img-format="tif"/></figure>
</drawings>
<search-report-data id="srep" lang="en" srep-office="EP" date-produced=""><doc-page id="srep0001" file="srep0001.tif" wi="157" he="233" type="tif"/><doc-page id="srep0002" file="srep0002.tif" wi="155" he="233" type="tif"/></search-report-data><search-report-data date-produced="20200625" id="srepxml" lang="en" srep-office="EP" srep-type="ep-sr" status="n"><!--
 The search report data in XML is provided for the users' convenience only. It might differ from the search report of the PDF document, which contains the officially published data. The EPO disclaims any liability for incorrect or incomplete data in the XML for search reports.
 -->

<srep-info><file-reference-id>PA202002B</file-reference-id><application-reference><document-id><country>EP</country><doc-number>20167803.4</doc-number></document-id></application-reference><applicant-name><name>RaySearch Laboratories AB</name></applicant-name><srep-established srep-established="yes"/><srep-invention-title title-approval="yes"/><srep-abstract abs-approval="yes"/><srep-figure-to-publish figinfo="by-applicant"><figure-to-publish><fig-number>1c</fig-number></figure-to-publish></srep-figure-to-publish><srep-info-admin><srep-office><addressbook><text>MN</text></addressbook></srep-office><date-search-report-mailed><date>20200707</date></date-search-report-mailed></srep-info-admin></srep-info><srep-for-pub><srep-fields-searched><minimum-documentation><classifications-ipcr><classification-ipcr><text>A61N</text></classification-ipcr></classifications-ipcr></minimum-documentation></srep-fields-searched><srep-citations><citation id="sr-cit0001"><patcit dnum="EP3055024A1" id="sr-pcit0001" url="http://v3.espacenet.com/textdoc?DB=EPODOC&amp;IDX=EP3055024&amp;CY=ep"><document-id><country>EP</country><doc-number>3055024</doc-number><kind>A1</kind><name>KONINKL PHILIPS NV [NL]</name><date>20160817</date></document-id></patcit><category>X</category><rel-claims>1-8,11,12</rel-claims><category>Y</category><rel-claims>9,10</rel-claims><rel-passage><passage>* abstract *</passage></rel-passage><rel-passage><passage>* paragraphs [0001],  [0022] - [0032],  [0049] - [0052] *</passage><passage>* figures 1,2A,2B,2C,4 *</passage></rel-passage></citation><citation id="sr-cit0002"><patcit dnum="EP3081262A1" id="sr-pcit0002" url="http://v3.espacenet.com/textdoc?DB=EPODOC&amp;IDX=EP3081262&amp;CY=ep"><document-id><country>EP</country><doc-number>3081262</doc-number><kind>A1</kind><name>RAYSEARCH LAB AB [SE]</name><date>20161019</date></document-id></patcit><category>Y</category><rel-claims>9,10</rel-claims><rel-passage><passage>* abstract *</passage><passage>* paragraphs [0003],  [0029],  [0047],  [0048] *</passage></rel-passage></citation><citation id="sr-cit0003"><patcit dnum="EP3539616A1" id="sr-pcit0003" url="http://v3.espacenet.com/textdoc?DB=EPODOC&amp;IDX=EP3539616&amp;CY=ep"><document-id><country>EP</country><doc-number>3539616</doc-number><kind>A1</kind><name>KONINKLIJKE PHILIPS NV [NL]</name><date>20190918</date></document-id></patcit><category>A</category><rel-claims>1,11,12</rel-claims><rel-passage><passage>* abstract *</passage><passage>* paragraphs [0050] - [0057] *</passage><passage>* figure 1 *</passage></rel-passage></citation><citation id="sr-cit0004"><patcit dnum="WO2018053648A1" id="sr-pcit0004" url="http://v3.espacenet.com/textdoc?DB=EPODOC&amp;IDX=WO2018053648&amp;CY=ep"><document-id><country>WO</country><doc-number>2018053648</doc-number><kind>A1</kind><name>THE ROYAL INSTITUTION FOR THE ADVANCEMENT OF LEARNING/MCGILL UNIV [CA]</name><date>20180329</date></document-id></patcit><category>A</category><rel-claims>1,11,12</rel-claims><rel-passage><passage>* abstract *</passage><passage>* paragraphs [0003] - [0006],  [0020] - [0051] *</passage><passage>* figures 1,2A,2B,3 *</passage></rel-passage></citation><citation id="sr-cit0005"><patcit dnum="US2013090549A1" id="sr-pcit0005" url="http://v3.espacenet.com/textdoc?DB=EPODOC&amp;IDX=US2013090549&amp;CY=ep"><document-id><country>US</country><doc-number>2013090549</doc-number><kind>A1</kind><name>MELTSNER MICHAEL [US] ET AL</name><date>20130411</date></document-id></patcit><category>A</category><rel-claims>1,11,12</rel-claims><rel-passage><passage>* abstract *</passage><passage>* figures 1,4 *</passage><passage>* paragraphs [0002],  [0005],  [0006],  [0018],  [0023] - [0030] *</passage></rel-passage></citation></srep-citations><srep-admin><examiners><primary-examiner><name>Kretschmann, Jana</name></primary-examiner></examiners><srep-office><addressbook><text>Munich</text></addressbook></srep-office><date-search-completed><date>20200625</date></date-search-completed></srep-admin><!--							The annex lists the patent family members relating to the patent documents cited in the above mentioned European search report.							The members are as contained in the European Patent Office EDP file on							The European Patent Office is in no way liable for these particulars which are merely given for the purpose of information.							For more details about this annex : see Official Journal of the European Patent Office, No 12/82						--><srep-patent-family><patent-family><priority-application><document-id><country>EP</country><doc-number>3055024</doc-number><kind>A1</kind><date>20160817</date></document-id></priority-application><family-member><document-id><country>CN</country><doc-number>105792894</doc-number><kind>A</kind><date>20160720</date></document-id></family-member><family-member><document-id><country>EP</country><doc-number>3055024</doc-number><kind>A1</kind><date>20160817</date></document-id></family-member><family-member><document-id><country>JP</country><doc-number>6487929</doc-number><kind>B2</kind><date>20190320</date></document-id></family-member><family-member><document-id><country>JP</country><doc-number>2017500165</doc-number><kind>A</kind><date>20170105</date></document-id></family-member><family-member><document-id><country>US</country><doc-number>2016213949</doc-number><kind>A1</kind><date>20160728</date></document-id></family-member><family-member><document-id><country>WO</country><doc-number>2015044239</doc-number><kind>A1</kind><date>20150402</date></document-id></family-member></patent-family><patent-family><priority-application><document-id><country>EP</country><doc-number>3081262</doc-number><kind>A1</kind><date>20161019</date></document-id></priority-application><family-member><document-id><country>CN</country><doc-number>107708805</doc-number><kind>A</kind><date>20180216</date></document-id></family-member><family-member><document-id><country>EP</country><doc-number>3081262</doc-number><kind>A1</kind><date>20161019</date></document-id></family-member><family-member><document-id><country>US</country><doc-number>2018289980</doc-number><kind>A1</kind><date>20181011</date></document-id></family-member><family-member><document-id><country>WO</country><doc-number>2016166059</doc-number><kind>A2</kind><date>20161020</date></document-id></family-member></patent-family><patent-family><priority-application><document-id><country>EP</country><doc-number>3539616</doc-number><kind>A1</kind><date>20190918</date></document-id></priority-application><family-member><document-id><country>CN</country><doc-number>111867677</doc-number><kind>A</kind><date>20201030</date></document-id></family-member><family-member><document-id><country>EP</country><doc-number>3539616</doc-number><kind>A1</kind><date>20190918</date></document-id></family-member><family-member><document-id><country>EP</country><doc-number>3765151</doc-number><kind>A1</kind><date>20210120</date></document-id></family-member><family-member><document-id><country>JP</country><doc-number>2021509077</doc-number><kind>A</kind><date>20210318</date></document-id></family-member><family-member><document-id><country>US</country><doc-number>2021052916</doc-number><kind>A1</kind><date>20210225</date></document-id></family-member><family-member><document-id><country>WO</country><doc-number>2019174979</doc-number><kind>A1</kind><date>20190919</date></document-id></family-member></patent-family><patent-family><priority-application><document-id><country>WO</country><doc-number>2018053648</doc-number><kind>A1</kind><date>20180329</date></document-id></priority-application><family-member><document-id><country>CA</country><doc-number>3076903</doc-number><kind>A1</kind><date>20180329</date></document-id></family-member><family-member><document-id><country>US</country><doc-number>2019275352</doc-number><kind>A1</kind><date>20190912</date></document-id></family-member><family-member><document-id><country>WO</country><doc-number>2018053648</doc-number><kind>A1</kind><date>20180329</date></document-id></family-member></patent-family><patent-family><priority-application><document-id><country>US</country><doc-number>2013090549</doc-number><kind>A1</kind><date>20130411</date></document-id></priority-application><family-member><document-id><country>CN</country><doc-number>102939607</doc-number><kind>A</kind><date>20130220</date></document-id></family-member><family-member><document-id><country>EP</country><doc-number>2580698</doc-number><kind>A1</kind><date>20130417</date></document-id></family-member><family-member><document-id><country>RU</country><doc-number>2012157808</doc-number><kind>A</kind><date>20140720</date></document-id></family-member><family-member><document-id><country>US</country><doc-number>2013090549</doc-number><kind>A1</kind><date>20130411</date></document-id></family-member><family-member><document-id><country>WO</country><doc-number>2011154853</doc-number><kind>A1</kind><date>20111215</date></document-id></family-member></patent-family></srep-patent-family></srep-for-pub></search-report-data>
</ep-patent-document>
